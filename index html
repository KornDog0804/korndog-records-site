<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3b2aa2"/>
  <title>KornDog Records • Vinyl Therapy & Collectibles</title>

  <!-- Live PayPal SDK (your client id) -->
  <script src="https://www.paypal.com/sdk/js?client-id=AcU9sSdlnQlq_dsilwLNL2Kw5YQczqtoEpuYmoADtbJ7be3JaMUXpignQu2RiUcnBEuH_e-edGgSnYv8&currency=USD" defer></script>

  <style>
    :root{
      --bg1:#3b2aa2;--bg2:#0fa77f;--ink:#eaf4ff;--muted:#b6c2d1;--card:#0b1220;
      --green:hsl(142 76% 36%);--green2:hsl(142 76% 46%);--accent:#ffd166
    }
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--ink)}
    a{color:inherit;text-decoration:none}
    .btn{background:#0e1624;border:1px solid #253146;color:#d7e3f4;border-radius:10px;
      padding:12px 16px;cursor:pointer;min-height:44px}
    .btn:hover{background:#151f31}.btn.primary{background:var(--green);border-color:var(--green);color:#fff}
    .btn.primary:hover{background:var(--green2)}
    .badge{background:#121827;border:1px solid #243041;color:#a3d2ff;border-radius:999px;padding:2px 7px;margin-left:6px}
    .nav{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.95);backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,.1);padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;color:var(--accent);cursor:pointer}
    .brand img{width:34px;height:34px;border-radius:50%}
    .links{display:flex;gap:12px;align-items:center}
    main{min-height:calc(100vh - 60px)}
    .page{display:none}.page.active{display:block}

    /* Bigger hero */
    .hero{min-height:100vh;display:grid;place-items:center;text-align:center;padding:36px 20px}
    .hero-logo{width:300px;height:300px;border-radius:50%;background:rgba(255,255,255,.12);
      border:2px solid rgba(255,255,255,.3);display:grid;place-items:center;margin:0 auto 24px;cursor:pointer;overflow:hidden}
    .hero-logo img{width:72%;height:auto;border-radius:50%}
    .hero h1{font-size:56px;line-height:1.05;margin:10px 0 10px;font-weight:900}
    .sub{color:#dfe9f8;max-width:700px;margin:0 auto 18px;font-size:18px}
    .cta{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:10px}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    .card{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.1);border-radius:14px;overflow:hidden}
    .card img{display:block;width:100%;height:200px;object-fit:cover;background:#0b1220}
    .card .pad{padding:14px}
    .item-title{font-weight:800;margin:8px 0 6px}
    .price{color:#c4e6ff;margin-bottom:12px;font-weight:600}
    .store-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:#0f1729;border:1px solid #273043;color:#d7e3f4;border-radius:8px;padding:8px 12px;cursor:pointer}
    .tab.active,.tab:hover{background:#172136}

    /* Cart drawer */
    .drawer{position:fixed;top:0;right:-440px;width:440px;max-width:95vw;height:100vh;background:#0c1423;color:#eaf4ff;
      border-left:1px solid #253146;transition:right .28s ease;display:flex;flex-direction:column;z-index:60}
    .drawer.open{right:0}
    .drawer header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid #223045}
    .drawer main{flex:1;overflow:auto;padding:14px}
    .cart-item{display:flex;gap:12px;border:1px solid #223045;border-radius:10px;padding:12px;margin-bottom:10px}
    .cart-item img{width:60px;height:60px;object-fit:cover;border-radius:8px}
    .drawer footer{border-top:1px solid #223045;padding:14px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;gap:8px}
    .total{font-size:18px;border-top:1px solid #233046;padding-top:8px;margin-top:8px}

    /* Admin panel */
    .admin{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);display:none;z-index:80}
    .admin.show{display:block}
    .admin-inner{position:absolute;right:0;top:0;width:100%;max-width:980px;height:100%;background:#0b1220;border-left:1px solid #223045;overflow:auto}
    .adm-head{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid #223045}
    .admin-grid{display:grid;grid-template-columns:380px 1fr;gap:14px;padding:14px}
    .admin-card{background:#0e1628;border:1px solid #223145;border-radius:12px;padding:14px}
    label{display:block;font-size:13px;margin:10px 0;color:#cfe0ff}
    input,select,textarea{width:100%;background:#0b1322;border:1px solid #273246;color:#e6f1ff;border-radius:8px;padding:9px;margin-top:6px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .photo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:10px 0}
    .ph{background:#0b1322;border:1px solid #273246;border-radius:10px;padding:10px;text-align:center;cursor:pointer}
    .ph img{width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px}
    .ph input{display:none}

    @media (max-width:860px){
      .hero{min-height:100svh}
      .hero h1{font-size:42px}
      .hero-logo{width:240px;height:240px}
      .admin-grid{grid-template-columns:1fr}
      .drawer{width:100vw;max-width:100vw}
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <div class="brand" onclick="showPage('home')" title="Tap logo 5× for Admin">
      <img src="https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/ChatGPT%20Image%20Aug%2010%2C%202025%2C%2012_07_42%20AM.png" alt="KornDog"/>
      <span>KornDog Records</span>
    </div>
    <div class="links">
      <a href="#" onclick="showPage('home')">Home</a>
      <a href="#" onclick="showPage('store')">Shop</a>
      <a href="#" onclick="showPage('about')">About</a>
      <button class="btn" onclick="openCart()">Cart <span id="cartCount" class="badge">0</span></button>
    </div>
  </nav>

  <!-- PAGES -->
  <main>
    <!-- HOME -->
    <section id="home" class="page active">
      <div class="hero">
        <div class="hero-logo" onclick="adminTap()">
          <img src="https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/ChatGPT%20Image%20Aug%2010%2C%202025%2C%2012_07_42%20AM.png" alt="KornDog Logo">
        </div>
        <h1>Vinyl Therapy Always On Deck</h1>
        <p class="sub">Hand-picked records, Funkos & collectibles for music lovers and pop culture enthusiasts.</p>
        <div class="cta">
          <button class="btn primary" onclick="showPage('store')">Enter The Shop</button>
          <button class="btn" onclick="showPage('about')">About</button>
        </div>
      </div>
    </section>

    <!-- STORE -->
    <section id="store" class="page">
      <div class="container">
        <header class="store-head">
          <h2>Explore Our Collections</h2>
          <div class="tabs">
            <button class="tab active" onclick="filterProducts('all',this)">All</button>
            <button class="tab" onclick="filterProducts('vinyl',this)">Vinyl</button>
            <button class="tab" onclick="filterProducts('cd',this)">CDs</button>
            <button class="tab" onclick="filterProducts('funko',this)">Funkos</button>
            <button class="tab" onclick="filterProducts('collectible',this)">Collectibles</button>
          </div>
        </header>
        <div id="grid" class="grid"></div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="page">
      <div class="container" style="padding-top:30px;padding-bottom:60px">
        <h2>About KornDog Records</h2>
        <p>Records became therapy… needle to groove. Every spin pulls me back—riding shotgun with my old man, laughing with my kids, slow dancing with my wife. This site is about soul and stories pressed into wax.</p>
      </div>
    </section>
  </main>

  <!-- CART DRAWER -->
  <aside class="drawer" id="drawer">
    <header><strong>Your Cart</strong><button class="btn" onclick="closeCart()">Close</button></header>
    <main id="cartList"></main>
    <footer>
      <div class="row"><span>Subtotal:</span><strong id="subtotal">$0.00</strong></div>
      <div class="row"><span class="small">Discount:</span><span id="discount">$0.00</span></div>
      <div class="row"><span class="small">Tax (6%):</span><span id="tax">$0.00</span></div>
      <div class="row total"><span>Total:</span><strong id="grand">$0.00</strong></div>
      <div id="paypal-buttons" class="paypal"></div>
      <button class="btn" onclick="clearCart()" style="width:100%;margin-top:10px">Clear cart</button>
    </footer>
  </aside>

  <!-- ADMIN PANEL -->
  <div id="admin" class="admin">
    <div class="admin-inner">
      <div class="adm-head">
        <strong>Admin Panel</strong>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="backup()">Backup</button>
          <button class="btn" onclick="importBackup()">Import</button>
          <button class="btn" onclick="hideAdmin()">Close</button>
        </div>
      </div>

      <div class="admin-grid">
        <!-- Add/Edit -->
        <form id="prodForm" class="admin-card" onsubmit="saveProduct(event)">
          <h3>Add / Edit Product</h3>
          <label>Title<input id="pTitle" required></label>
          <div class="row2">
            <label>Category
              <select id="pType" required>
                <option value="vinyl">Vinyl</option><option value="cd">CD</option>
                <option value="funko">Funko</option><option value="collectible">Collectible</option>
              </select>
            </label>
            <label>Price ($)
              <input id="pPrice" type="number" step="0.01" required onblur="snapPrice(this)">
              <small style="color:#9fb4c9">Snaps to .99 or .59</small>
            </label>
          </div>

          <!-- 2×2 photo pickers (from library/camera) -->
          <div class="photo-grid">
            <div class="ph" onclick="document.getElementById('pFront').click()">
              <img id="prevFront" src="https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/ChatGPT%20Image%20Aug%2010%2C%202025%2C%2012_07_42%20AM.png" alt="Front">
              <input id="pFront" type="file" accept="image/*" capture="environment" onchange="readImage(this,'prevFront')"><span>Front</span>
            </div>
            <div class="ph" onclick="document.getElementById('pBack').click()">
              <img id="prevBack" src="https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/Screenshot_20250827-140949.png" alt="Back">
              <input id="pBack" type="file" accept="image/*" capture="environment" onchange="readImage(this,'prevBack')"><span>Back</span>
            </div>
            <div class="ph" onclick="document.getElementById('pAlt1').click()">
              <img id="prevAlt1" src="https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/1000043471-removebg-preview.png" alt="Alt1">
              <input id="pAlt1" type="file" accept="image/*" capture="environment" onchange="readImage(this,'prevAlt1')"><span>Alt 1</span>
            </div>
            <div class="ph" onclick="document.getElementById('pAlt2').click()">
              <img id="prevAlt2" src="https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/ChatGPT%20Image%20Aug%2010%2C%202025%2C%2012_07_42%20AM.png" alt="Alt2">
              <input id="pAlt2" type="file" accept="image/*" capture="environment" onchange="readImage(this,'prevAlt2')"><span>Alt 2</span>
            </div>
          </div>

          <label>Description<textarea id="pDesc" rows="3" placeholder="Grade, condition, notes…"></textarea></label>
          <button class="btn primary" type="submit">Save Product</button>
          <button class="btn" type="button" onclick="resetForm()" style="margin-left:6px">Reset</button>
        </form>

        <!-- Inventory list -->
        <div class="admin-card">
          <h3>Inventory</h3>
          <div id="adminList"></div>
        </div>
      </div>

      <!-- Hero Photo Manager (simple) -->
      <div class="admin-card" style="margin:14px">
        <h3>Hero Photo Manager</h3>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="heroPicker" type="file" accept="image/*" capture="environment" onchange="addHeroFromFile()"/>
          <button class="btn" onclick="document.getElementById('heroPicker').click()">Add from Library</button>
          <div style="display:flex;align-items:center;gap:8px">Active: <img id="heroActiveThumb" src="" alt="" style="width:34px;height:34px;border-radius:6px;object-fit:cover"></div>
        </div>
        <div id="heroStrip" style="display:flex;gap:12px;flex-wrap:wrap"></div>
      </div>
    </div>
  </div>

  <script>
  // ---------- CONSTANTS ----------
  const LOGO  = "https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/ChatGPT%20Image%20Aug%2010%2C%202025%2C%2012_07_42%20AM.png";
  const ZOMB  = "https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/Screenshot_20250827-140949.png";
  const CHIBI = "https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/1000043471-removebg-preview.png";
  const TAX_RATE = 0.06;
  const DISCOUNT_LADDER = [{threshold:50,percent:5},{threshold:100,percent:10},{threshold:200,percent:15}];

  // ---------- STATE ----------
  let products = [];
  let cart = [];
  let editId = null;
  let filterKey = 'all';
  let tapCount = 0;
  let heroImages = [];
  let activeHero = '';

  // ---------- HELPERS ----------
  const $ = s => document.querySelector(s);
  const fmt = n => '$' + (Math.round(n*100)/100).toFixed(2);
  const r2 = n => Math.round(n*100)/100;

  function snapPrice(input){
    let v = parseFloat(input.value||0); if(isNaN(v)) return;
    const d = Math.floor(v); const cents = Math.round((v-d)*100);
    input.value = (d + (Math.abs(cents-59)<Math.abs(cents-99) ? 0.59 : 0.99)).toFixed(2);
  }
  function readImage(inp, targetId){
    const f = inp.files?.[0]; if(!f) return;
    const rd=new FileReader(); rd.onload=e=>{document.getElementById(targetId).src=e.target.result}; rd.readAsDataURL(f);
  }

  function showPage(id){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id==='home'){ // update hero image
      $('.hero-logo img').src = activeHero || LOGO;
    }
  }

  // ---------- ADMIN GATE ----------
  function adminTap(){
    tapCount++;
    if(tapCount>=5){
      tapCount=0;
      const pass=prompt('Admin password:');
      if(pass==='vinyltherapy'){ showAdmin(); } else if(pass){ alert('Wrong password'); }
    }
    setTimeout(()=>tapCount=0,8000);
  }
  function showAdmin(){ $('#admin').classList.add('show'); renderAdmin(); renderHeroManager(); }
  function hideAdmin(){ $('#admin').classList.remove('show'); }

  // ---------- PRODUCTS PERSISTENCE ----------
  function loadProducts(){
    try{ products = JSON.parse(localStorage.getItem('kdr_products')||'[]'); }catch(e){ products=[]; }
    if(!products.length){
      products = [
        {id:'p1', title:'Sleep Token - Even In Arcadia', type:'vinyl', price:85.99, desc:'House Vendetta Edition', imgFront:LOGO, imgBack:ZOMB},
        {id:'p2', title:'Pink Floyd - Dark Side of the Moon', type:'vinyl', price:29.99, imgFront:ZOMB, imgBack:LOGO},
        {id:'p3', title:'The Cure - Disintegration', type:'cd', price:32.99, imgFront:ZOMB, imgBack:LOGO},
        {id:'p4', title:'Funko Pop! Music - Freddie Mercury', type:'funko', price:19.99, imgFront:CHIBI, imgBack:LOGO},
        {id:'p5', title:'Funko Pop! Horror - Pennywise', type:'funko', price:24.99, imgFront:CHIBI, imgBack:LOGO},
        {id:'p6', title:'The Cure - Seventeen Seconds (Remastered)', type:'cd', price:15.99, imgFront:ZOMB, imgBack:LOGO},
      ];
      saveProducts();
    }
  }
  function saveProducts(){ localStorage.setItem('kdr_products', JSON.stringify(products)); }

  // ---------- HERO IMAGES ----------
  function loadHero(){
    try{
      heroImages = JSON.parse(localStorage.getItem('kdr_heros')||'[]');
      activeHero = localStorage.getItem('kdr_hero_active') || LOGO;
    }catch(e){ heroImages=[]; activeHero=LOGO; }
  }
  function saveHero(){ localStorage.setItem('kdr_heros', JSON.stringify(heroImages)); localStorage.setItem('kdr_hero_active', activeHero); }
  function addHeroFromFile(){
    const inp = document.getElementById('heroPicker'); const f=inp.files?.[0]; if(!f) return;
    const rd = new FileReader(); rd.onload=e=>{ heroImages.unshift(e.target.result); saveHero(); renderHeroManager(); $('.hero-logo img').src = activeHero; }; rd.readAsDataURL(f);
  }
  function renderHeroManager(){
    $('#heroActiveThumb').src = activeHero || LOGO;
    const strip = $('#heroStrip'); strip.innerHTML='';
    [activeHero,...heroImages].forEach((src, idx)=>{
      const box = document.createElement('div');
      box.style.cssText='width:180px;background:#0b1322;border:1px solid #273246;border-radius:10px;padding:10px';
      box.innerHTML = `
        <img src="${src}" style="width:100%;height:110px;object-fit:cover;border-radius:8px;margin-bottom:8px">
        <div style="display:flex;gap:8px">
          <button class="btn primary" style="flex:1">Make Active</button>
          ${idx>0?'<button class="btn" style="flex:1">Delete</button>':''}
        </div>`;
      const [makeBtn,delBtn] = box.querySelectorAll('button');
      makeBtn.onclick = ()=>{ activeHero = src; saveHero(); renderHeroManager(); $('.hero-logo img').src = activeHero; };
      if(delBtn){ delBtn.onclick = ()=>{ heroImages = heroImages.filter(h=>h!==src); if(activeHero===src) activeHero=LOGO; saveHero(); renderHeroManager(); }; }
      strip.appendChild(box);
    });
  }

  // ---------- ADMIN FORM ----------
  function resetForm(){
    editId=null; $('#prodForm').reset();
    $('#prevFront').src=LOGO; $('#prevBack').src=ZOMB; $('#prevAlt1').src=CHIBI; $('#prevAlt2').src=LOGO;
  }
  function saveProduct(e){
    e.preventDefault();
    const p = {
      id: editId || 'p_'+Date.now(),
      title: $('#pTitle').value.trim(),
      type: $('#pType').value,
      price: parseFloat($('#pPrice').value||0),
      desc: $('#pDesc').value.trim(),
      imgFront: $('#prevFront').src, imgBack: $('#prevBack').src,
      alt1: $('#prevAlt1').src, alt2: $('#prevAlt2').src
    };
    if(editId){ const i=products.findIndex(x=>x.id===editId); if(i>-1) products[i]=p; }
    else{ products.unshift(p); }
    saveProducts(); resetForm(); render(); renderAdmin();
  }
  function renderAdmin(){
    const list = $('#adminList'); list.innerHTML='';
    products.forEach(p=>{
      const row = document.createElement('div');
      row.className='row';
      row.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;flex:1">
          <img src="${p.imgFront||LOGO}" style="width:46px;height:46px;border-radius:8px;object-fit:cover">
          <div class="grow">
            <strong>${p.title}</strong><br><span class="small">${p.type} • ${fmt(p.price)}</span>
          </div>
        </div>
        <button class="btn btn-edit" data-id="${p.id}">Edit</button>
        <button class="btn btn-del"  data-id="${p.id}">Delete</button>
      `;
      list.appendChild(row);
    });

    // Robust event handling for buttons (fixes "Delete doesn't work")
    list.querySelectorAll('.btn-edit').forEach(b=>{
      b.onclick = ()=>{ const id=b.dataset.id; const p=products.find(x=>x.id===id); if(!p) return;
        editId=id; $('#pTitle').value=p.title; $('#pType').value=p.type; $('#pPrice').value=p.price.toFixed(2);
        $('#pDesc').value=p.desc||''; $('#prevFront').src=p.imgFront||LOGO; $('#prevBack').src=p.imgBack||ZOMB;
        $('#prevAlt1').src=p.alt1||CHIBI; $('#prevAlt2').src=p.alt2||LOGO; window.scrollTo({top:0,behavior:'smooth'});
      };
    });
    list.querySelectorAll('.btn-del').forEach(b=>{
      b.onclick = ()=>{ const id=b.dataset.id;
        if(confirm('Delete this product?')){ products = products.filter(x=>x.id!==id); saveProducts(); render(); renderAdmin(); }
      };
    });
  }

  // ---------- STORE RENDER ----------
  function filterProducts(key, btn){
    filterKey = key; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); if(btn) btn.classList.add('active'); render();
  }
  function render(){
    const grid = $('#grid'); grid.innerHTML='';
    const list = filterKey==='all' ? products : products.filter(p=>p.type===filterKey);
    if(!list.length){ grid.innerHTML='<div class="card pad">No items yet.</div>'; return; }
    list.forEach(p=>{
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <img src="${p.imgFront||LOGO}" alt="${p.title}">
        <div class="pad">
          <div class="item-title">${p.title}</div>
          <div class="price">${fmt(p.price)}</div>
          <div class="row">
            <button class="btn" onclick="alert('${p.title}\\n\\n${(p.desc||'')}')">View</button>
            <button class="btn primary" onclick="addToCart('${p.id}')">Add</button>
          </div>
        </div>`;
      grid.appendChild(card);
    });
  }

  // ---------- CART ----------
  function loadCart(){ try{ cart = JSON.parse(localStorage.getItem('kdr_cart')||'[]'); }catch(e){ cart=[]; } updateCartCount(); }
  function saveCart(){ localStorage.setItem('kdr_cart', JSON.stringify(cart)); updateCartCount(); }
  function updateCartCount(){ $('#cartCount').textContent = cart.reduce((a,i)=>a+(i.qty||1),0); }
  function addToCart(id){
    const p = products.find(x=>x.id===id); if(!p) return;
    const i = cart.findIndex(x=>x.id===id);
    if(i>-1) cart[i].qty += 1; else cart.push({id:p.id,title:p.title,price:p.price,img:p.imgFront,qty:1});
    saveCart(); renderCart(); openCart();
  }
  function removeFromCart(index){ cart.splice(index,1); saveCart(); renderCart(); }
  function clearCart(){ if(confirm('Clear entire cart?')){ cart=[]; saveCart(); renderCart(); } }
  function openCart(){ $('#drawer').classList.add('open'); renderCart(); }
  function closeCart(){ $('#drawer').classList.remove('open'); }

  // Totals in cents to avoid rounding mismatch
  function calcTotals(){
    let subC=0; cart.forEach(i=>subC += Math.round(i.price*100)*(i.qty||1));
    let discC=0;
    DISCOUNT_LADDER.forEach(t=>{ if(subC>=Math.round(t.threshold*100)) discC=Math.max(discC, Math.round(subC*t.percent/100)); });
    const taxBase = Math.max(0, subC-discC);
    const taxC = Math.round(taxBase*TAX_RATE);
    const grandC = taxBase + taxC;
    return { subC, discC, taxC, grandC, sub:subC/100, disc:discC/100, tax:taxC/100, grand:grandC/100 };
  }

  // PayPal
  function renderPayPalButtons(){
    const container = document.getElementById('paypal-buttons');
    container.innerHTML = '';
    if(!window.paypal || cart.length===0) return;

    const {subC,discC,taxC,grandC} = calcTotals();

    paypal.Buttons({
      style:{layout:'vertical',color:'gold',shape:'pill'},
      createOrder:(data, actions)=>{
        return actions.order.create({
          purchase_units:[{
            amount:{
              currency_code:'USD',
              value:(grandC/100).toFixed(2),
              breakdown:{
                item_total:{currency_code:'USD', value:(subC/100).toFixed(2)},
                discount:{currency_code:'USD', value:(discC/100).toFixed(2)},
                tax_total:{currency_code:'USD', value:(taxC/100).toFixed(2)}
              }
            },
            items: cart.map(i=>({
              name:i.title,
              quantity:i.qty,
              unit_amount:{currency_code:'USD', value:i.price.toFixed(2)},
              category:'PHYSICAL_GOODS'
            }))
          }]
        });
      },
      onApprove:(data,actions)=>{
        return actions.order.capture().then(()=>{
          cart=[]; saveCart(); renderCart(); alert('Thanks! Your order was completed.');
          closeCart();
        });
      },
      onError:(err)=>{ console.error(err); alert('Payment error. Please try again.'); }
    }).render('#paypal-buttons');
  }

  function renderCart(){
    const list = $('#cartList'); list.innerHTML='';
    cart.forEach((i,idx)=>{
      const row = document.createElement('div'); row.className='cart-item';
      row.innerHTML = `
        <img src="${i.img||LOGO}" alt="${i.title}">
        <div class="grow">
          <div><strong>${i.title}</strong></div>
          <div class="small">${i.qty} × ${fmt(i.price)}</div>
        </div>
        <button class="btn" onclick="removeFromCart(${idx})">Remove</button>`;
      list.appendChild(row);
    });

    const t = calcTotals();
    $('#subtotal').textContent = fmt(t.sub);
    $('#discount').textContent = '-' + fmt(t.disc);
    $('#tax').textContent = fmt(t.tax);
    $('#grand').textContent = fmt(t.grand);

    renderPayPalButtons();
  }

  // ---------- BACKUP ----------
  function backup(){
    const blob = new Blob([JSON.stringify({products,heroImages,activeHero},null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kdr-backup.json'; a.click();
  }
  function importBackup(){
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const rd=new FileReader(); rd.onload=x=>{
        try{
          const data=JSON.parse(x.target.result);
          if(Array.isArray(data.products)) products=data.products;
          if(Array.isArray(data.heroImages)) heroImages=data.heroImages;
          if(data.activeHero) activeHero=data.activeHero;
          saveProducts(); saveHero(); render(); renderAdmin(); renderHeroManager();
          alert('Import complete');
        }catch(err){ alert('Bad backup file'); }
      }; rd.readAsText(f);
    };
    inp.click();
  }

  // ---------- INIT ----------
  (function init(){
    loadProducts(); loadCart(); loadHero(); render(); $('.hero-logo img').src = activeHero || LOGO;
  })();
  </script>
</body>
</html>
