<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#3b2aa2"/>
<title>KornDog Records • Vinyl Therapy & Collectibles</title>

<!-- PayPal: live client id you provided -->
<script src="https://www.paypal.com/sdk/js?client-id=AcU9sSdlnQlq_dsilwLNL2Kw5YQczqtoEpuYmoADtbJ7be3JaMUXpignQu2RiUcnBEuH_e-edGgSnYv8&currency=USD" defer></script>

<style>
:root{
  --bg1:#3b2aa2;--bg2:#0fa77f;--ink:#eaf4ff;--muted:#b6c2d1;--card:#0b1220;
  --green:hsl(142 76% 36%);--green2:hsl(142 76% 46%);--accent:#ffd166;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,Segoe UI,Helvetica,Arial,sans-serif;
  color:var(--ink);background:linear-gradient(135deg,var(--bg1),var(--bg2));
  background-attachment:fixed;
}
a{color:inherit;text-decoration:none}
.btn{background:#0e1624;border:1px solid #253146;color:#d7e3f4;border-radius:10px;padding:12px 16px;cursor:pointer;min-height:44px}
.btn:hover{background:#151f31}
.btn.primary{background:var(--green);border-color:var(--green);color:#fff}
.btn.primary:hover{background:var(--green2)}
.badge{background:#121827;border:1px solid #243041;color:#a3d2ff;border-radius:999px;padding:2px 7px;margin-left:6px}
.small{font-size:12px;color:#9fb4c9}

.nav{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.95);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.1);padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
.brand{display:flex;gap:10px;align-items:center;font-weight:800;color:var(--accent);cursor:pointer}
.links{display:flex;gap:12px;align-items:center}
.links a{padding:8px 12px;border-radius:6px}
.links a:hover{background:rgba(255,255,255,0.1)}

main{min-height:calc(100vh - 60px)}
.page{display:none} .page.active{display:block}

.hero{min-height:100svh;display:grid;place-items:center;text-align:center;padding:36px 20px}
.hero-logo{width:260px;height:260px;border-radius:50%;background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.3);display:grid;place-items:center;margin:0 auto 24px;overflow:hidden}
.hero h1{font-size:54px;line-height:1.05;margin:10px 0;font-weight:900}
.sub{color:#dfe9f8;max-width:700px;margin:0 auto 18px;font-size:18px}
.cta{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:10px}

.container{max-width:1200px;margin:0 auto;padding:18px}
.store-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#0f1729;border:1px solid #273043;color:#d7e3f4;border-radius:8px;padding:8px 12px;cursor:pointer}
.tab.active,.tab:hover{background:#172136}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.1);border-radius:14px;overflow:hidden}
.card-head{position:relative;height:200px;background:#0b1220}
.card-head img{width:100%;height:100%;object-fit:cover}
.flipBtn{position:absolute;right:10px;top:10px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:6px 10px;font-size:12px}
.sides{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .45s ease}
.card.flipped .sides{transform:rotateY(180deg)}
.side{position:absolute;inset:0;backface-visibility:hidden}
.side.back{transform:rotateY(180deg)}
.card .pad{padding:14px}
.item-title{font-weight:800;margin:8px 0 6px;font-size:18px}
.price{color:#c4e6ff;margin-bottom:12px;font-weight:600}
.row{display:flex;justify-content:space-between;align-items:center;gap:8px}

.drawer{position:fixed;top:0;right:-440px;width:440px;max-width:95vw;height:100vh;background:#0c1423;color:#eaf4ff;border-left:1px solid #253146;transition:right .3s ease;display:flex;flex-direction:column;z-index:60}
.drawer.open{right:0}
.drawer header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid #223045}
.drawer main{flex:1;overflow:auto;padding:14px}
.cart-item{display:flex;gap:12px;border:1px solid #223045;border-radius:10px;padding:12px;margin-bottom:10px;background:rgba(0,0,0,.2)}
.cart-item img{width:60px;height:60px;object-fit:cover;border-radius:8px}
.drawer footer{border-top:1px solid #223045;padding:14px}

.admin{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);display:none;z-index:80}
.admin.show{display:block}
.admin-inner{position:absolute;right:0;top:0;width:100%;max-width:980px;height:100%;background:#0b1220;border-left:1px solid #223045;overflow:auto}
.adm-head{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid #223045}
.admin-grid{display:grid;grid-template-columns:380px 1fr;gap:14px;padding:14px}
.admin-card{background:#0e1628;border:1px solid #223145;border-radius:12px;padding:14px}
label{display:block;font-size:13px;margin:10px 0;color:#cfe0ff}
input,select,textarea{width:100%;background:#0b1322;border:1px solid #273246;color:#e6f1ff;border-radius:8px;padding:9px;margin-top:6px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.photo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:10px 0}
.ph{background:#0b1322;border:1px solid #273246;border-radius:10px;padding:10px;text-align:center;cursor:pointer;position:relative}
.ph img{width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px}
.ph input{display:none}
.ph .hint{position:absolute;left:10px;bottom:10px;font-size:11px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);padding:2px 6px;border-radius:6px}

.kitty-portal{position:fixed;left:12px;bottom:12px;z-index:70;width:54px;height:54px;border-radius:50%;border:2px solid #233046;background:#0b1220;display:grid;place-items:center}
.kitty-portal img{width:44px;height:44px;border-radius:50%;object-fit:cover}

.radio-dock{position:fixed;inset:auto 0 0 0;background:#0d1422;border-top:1px solid #223045;z-index:65;display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px 14px}
.radio-left{display:flex;align-items:center;gap:10px}
.radio-pill{background:#172136;border:1px solid #273043;color:#d7e3f4;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
.radio-pill.active{background:var(--accent);color:#000;border-color:var(--accent)}
.playBtn{width:34px;height:34px;border-radius:50%;display:grid;place-items:center;background:var(--green);color:#fff;border:0;font-weight:700}
.nowPlaying{margin-left:auto;color:#ffd166;font-size:13px}
.moreBtn{background:#0f1729;border:1px solid #273043;border-radius:8px;padding:6px}

.about-wrap{padding:24px}
.about-panel{background:linear-gradient(135deg,#ff5ea8,#2bd8a3);border:1px solid rgba(255,255,255,.25);border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
.about-panel h2{margin-top:0;font-size:36px}
.about-panel p{font-size:18px;line-height:1.6}

@media (max-width:860px){
  .hero h1{font-size:42px}.hero-logo{width:210px;height:210px}
  .admin-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <nav class="nav">
    <div class="brand" onclick="go('#home')">🎵 KornDog Records</div>
    <div class="links">
      <span id="npTop" class="small" style="margin-right:10px;display:none">🎵 <span id="npTopText"></span></span>
      <a href="#home">Home</a>
      <a href="#store">Shop</a>
      <a href="#about">About</a>
      <a href="#cart">Cart <span id="cartCount" class="badge">0</span></a>
    </div>
  </nav>

  <main>
    <!-- HOME -->
    <section id="home" class="page active">
      <div class="hero">
        <div class="hero-logo" id="heroLogo"><div style="font-size:72px">🎵</div></div>
        <h1>Vinyl Therapy Always On Deck</h1>
        <p class="sub">Hand-picked records, Funkos & collectibles for music lovers and pop culture enthusiasts.</p>
        <div class="cta">
          <button class="btn primary" onclick="go('#store')">Enter The Shop</button>
          <button class="btn" onclick="go('#about')">About</button>
        </div>
      </div>
    </section>

    <!-- STORE -->
    <section id="store" class="page">
      <div class="container">
        <header class="store-head">
          <h2>Explore Our Collections</h2>
          <div class="tabs">
            <button class="tab active" onclick="filterProducts('all',this)">All</button>
            <button class="tab" onclick="filterProducts('vinyl',this)">Vinyl</button>
            <button class="tab" onclick="filterProducts('cd',this)">CDs</button>
            <button class="tab" onclick="filterProducts('funko',this)">Funkos</button>
            <button class="tab" onclick="filterProducts('collectible',this)">Collectibles</button>
          </div>
        </header>
        <div id="grid" class="grid"></div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="page">
      <div class="container about-wrap">
        <div class="about-panel">
          <h2>About Me (Korndog Records)</h2>
          <p>Music's always been in my blood — thanks to my mom and dad — but vinyl didn't hit me 'til after my mom's wreck. She didn't make it. That moment split my world in two. Records became therapy. No therapist. No pills. Just needle to groove. It grounded me. Every spin pulls me back — riding shotgun with my old man, laughing with my kids, slow dancing with my wife.</p>
          <p>This site? It's not about algorithms, trends, or fake hype. It's about soul. About stories. About memories you can hear. Every record here means something. It's not just wax — it's a vibe. A scar. A time machine.</p>
          <p>If you get it, you get it. Welcome to Korndog Records — where vinyl therapy is always on deck.</p>

          <h3 style="margin-top:18px;margin-bottom:8px">Zombie Kitty Story</h3>
          <p>Zombie Kitty isn't just a mascot — she's family. Born from a Friday the 13th tattoo session with my daughter Elizabeth, she's got a purple rose eye and a stitched-up smile — part nightmare, part love letter. She reminds us scars can become art, and the broken pieces still tell a story. Like vinyl, she never really fades — she comes back to life every time the needle drops.</p>

          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
            <a class="btn primary" target="_blank" href="https://www.discogs.com/user/korndog0804">🎵 Discogs Profile</a>
            <a class="btn primary" target="_blank" href="https://whatnot.com/s/OisexUo7">📺 Whatnot Live Shows</a>
            <button class="btn" onclick="adminPortal()">🔒 Admin Portal</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CART -->
    <section id="cart" class="page">
      <div class="container" style="padding-top:18px;padding-bottom:80px">
        <h2>Your Cart</h2>
        <div id="cartList" style="margin-bottom:20px"></div>
        <div style="max-width:420px;margin-left:auto;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:16px">
          <div class="row"><span>Subtotal:</span><strong id="subtotal">$0.00</strong></div>
          <div class="row small"><span>Discount:</span><span id="discount">$0.00</span></div>
          <div class="row small"><span>Tax (6%):</span><span id="tax">$0.00</span></div>
          <div class="row" style="font-weight:800;font-size:18px;border-top:1px solid rgba(255,255,255,.15);padding-top:8px"><span>Total:</span><span id="grand">$0.00</span></div>
          <div id="paypal-buttons" style="margin-top:14px"></div>
          <button class="btn" onclick="clearCart()" style="width:100%;margin-top:10px">Clear Cart</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Admin overlay -->
  <div id="admin" class="admin" aria-hidden="true">
    <div class="admin-inner">
      <div class="adm-head">
        <strong>Admin Panel</strong>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="backup()">Backup</button>
          <button class="btn" onclick="importBackup()">Import</button>
          <button class="btn" onclick="hideAdmin()">Close</button>
        </div>
      </div>

      <div class="admin-grid">
        <form id="prodForm" class="admin-card" onsubmit="saveProduct(event)">
          <h3>Add / Edit Product</h3>
          <label>Title<input id="pTitle" required></label>
          <div class="row2">
            <label>Category
              <select id="pType" required>
                <option value="vinyl">Vinyl</option><option value="cd">CD</option>
                <option value="funko">Funko</option><option value="collectible">Collectible</option>
              </select>
            </label>
            <label>Price ($)
              <input id="pPrice" type="number" step="0.01" required onblur="snapPrice(this)">
              <div class="small">Snaps to .99 or .59</div>
            </label>
          </div>

          <!-- 2×2 image picker (phone library friendly) -->
          <div class="photo-grid">
            <label class="ph">
              <img id="prevFront" alt="Front"/>
              <span class="hint">Tap to add photo</span>
              <input id="pFront" type="file" accept="image/*" onchange="readImage(this,'prevFront')">
              <div class="small">Front</div>
            </label>
            <label class="ph">
              <img id="prevBack" alt="Back"/>
              <span class="hint">Tap to add photo</span>
              <input id="pBack" type="file" accept="image/*" onchange="readImage(this,'prevBack')">
              <div class="small">Back</div>
            </label>
            <label class="ph">
              <img id="prevAlt1" alt="Alt 1"/>
              <span class="hint">Tap to add photo</span>
              <input id="pAlt1" type="file" accept="image/*" onchange="readImage(this,'prevAlt1')">
              <div class="small">Alt 1</div>
            </label>
            <label class="ph">
              <img id="prevAlt2" alt="Alt 2"/>
              <span class="hint">Tap to add photo</span>
              <input id="pAlt2" type="file" accept="image/*" onchange="readImage(this,'prevAlt2')">
              <div class="small">Alt 2</div>
            </label>
          </div>

          <label>Description<textarea id="pDesc" rows="3" placeholder="Grade, condition, notes…"></textarea></label>
          <div style="display:flex;gap:8px">
            <button class="btn primary" type="submit">Save Product</button>
            <button class="btn" type="button" onclick="resetForm()">Reset</button>
          </div>
        </form>

        <div class="admin-card">
          <h3>Inventory</h3>
          <div id="adminList"></div>
        </div>
      </div>

      <div class="admin-card" style="margin:14px">
        <h3>Hero Photo Manager</h3>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
          <input id="heroPicker" type="file" accept="image/*" onchange="addHeroFromFile()"/>
          <button class="btn" onclick="document.getElementById('heroPicker').click()">Add from Library</button>
          <div style="display:flex;align-items:center;gap:8px">Active:
            <img id="heroActiveThumb" src="" alt="" style="width:34px;height:34px;border-radius:6px;object-fit:cover">
          </div>
        </div>
        <div id="heroStrip" style="display:flex;gap:12px;flex-wrap:wrap"></div>
      </div>
    </div>
  </div>

  <!-- Kitty admin portal (tap 5×) -->
  <button class="kitty-portal" onclick="kittyTap()">
    <img src="https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/Screenshot_20250827-140949.png" alt="Kitty"/>
  </button>

  <!-- Radio dock -->
  <div class="radio-dock">
    <div class="radio-left">
      <button class="playBtn" id="playBtn" onclick="togglePlay()">▶</button>
      <div id="stationPills" style="display:flex;gap:6px;flex-wrap:wrap"></div>
    </div>
    <div class="nowPlaying" id="nowPlaying">Now Playing: <span id="npText">—</span></div>
    <button class="moreBtn" onclick="cycleStation()">⏭</button>
  </div>

  <!-- Hidden iframe player -->
  <iframe id="ytFrame" title="YouTube station" style="position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;border:0" allow="autoplay; encrypted-media"></iframe>

<script>
/* ------- Constants / Storage Keys ------- */
const K= {
  PRODUCTS:'kdr_products',
  HERO:'kdr_hero',
  HERO_IMGS:'kdr_hero_images',
  CART:'kdr_cart'
};
const LOGO = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><circle cx='100' cy='100' r='80' fill='%23ffd166'/><text x='100' y='110' text-anchor='middle' fill='%233b2aa2' font-family='sans-serif' font-size='24' font-weight='bold'>KornDog</text></svg>";
const ZOMB = "https://raw.githubusercontent.com/KornDog0804/korndog-records-site/main/Screenshot_20250827-140949.png";

/* ------- Radio stations (YouTube embeds) ------- */
const STATIONS = [
  {name:'Metalcore Meltdown', id:'naNuknf62FY'},
  {name:'Hatsune Miku', id:'2ENM9GVOuAI'},
  {name:'Dance Gavin Dance', id:'bR7r3uII-x8'}
];

let products = [], cart = [], editId=null, filterKey='all', heroImages=[], activeHero=LOGO;
let taps=0, tapTimer=null;
let currentStation=0, isPlaying=false;

/* ------- Helpers ------- */
const $ = s => document.querySelector(s);
const fmt = n => '$' + (Math.round(n*100)/100).toFixed(2);
function go(hash){ location.hash = hash; }
function snapPrice(el){
  let v=parseFloat(el.value||0); if(isNaN(v)) return;
  const d=Math.floor(v), c=Math.round((v-d)*100);
  el.value=(d+ (Math.abs(c-59)<Math.abs(c-99) ? 0.59 : 0.99)).toFixed(2);
}
function readImage(input, targetId){
  const f=input.files && input.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=e=>{ $('#'+targetId).src = e.target.result; }; rd.readAsDataURL(f);
}

/* ------- Router (hash) to avoid Netlify 404 ------- */
function route(){
  const id=(location.hash||'#home').replace('#','');
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  $('#'+id)?.classList.add('active');
  // show active hero on home
  if(id==='home'){ $('#heroLogo').innerHTML = `<img src="${activeHero}" style="width:100%;height:100%;object-fit:cover">`; }
}
window.addEventListener('hashchange',route);

/* ------- Products (persist to localStorage) ------- */
function loadProducts(){
  try{ products = JSON.parse(localStorage.getItem(K.PRODUCTS)||'[]'); }catch{ products=[]; }
  if(!products.length){
    products = [
      {id:'p1',title:'Sleep Token - Even In Arcadia',type:'vinyl',price:85.99,desc:'House Vendetta Edition',imgFront:LOGO,imgBack:ZOMB},
      {id:'p2',title:'Pink Floyd - Dark Side of the Moon',type:'vinyl',price:29.99,imgFront:ZOMB,imgBack:LOGO},
      {id:'p3',title:'The Cure - Disintegration',type:'cd',price:32.99,imgFront:ZOMB,imgBack:LOGO},
      {id:'p4',title:'Funko Pop! Music - Freddie Mercury',type:'funko',price:19.99,imgFront:LOGO,imgBack:ZOMB},
      {id:'p5',title:'Funko Pop! Horror - Pennywise',type:'funko',price:24.99,imgFront:LOGO,imgBack:ZOMB},
      {id:'p6',title:'The Cure - Seventeen Seconds (Remastered)',type:'cd',price:15.99,imgFront:LOGO,imgBack:ZOMB}
    ];
    saveProducts();
  }
}
function saveProducts(){ try{ localStorage.setItem(K.PRODUCTS,JSON.stringify(products)); }catch{} }

function resetForm(){
  editId=null; $('#prodForm').reset();
  $('#prevFront').src=''; $('#prevBack').src=''; $('#prevAlt1').src=''; $('#prevAlt2').src='';
}
function saveProduct(e){
  e.preventDefault();
  const p = {
    id: editId || 'p_'+Date.now(),
    title: $('#pTitle').value.trim(),
    type: $('#pType').value,
    price: parseFloat($('#pPrice').value||0),
    desc: $('#pDesc').value.trim(),
    imgFront: $('#prevFront').src || LOGO,
    imgBack:  $('#prevBack').src  || LOGO,
    alt1: $('#prevAlt1').src || '',
    alt2: $('#prevAlt2').src || ''
  };
  if(editId){ const i=products.findIndex(x=>x.id===editId); if(i>-1) products[i]=p; }
  else { products.unshift(p); }
  saveProducts(); resetForm(); render(); renderAdmin();
}
function editProduct(id){
  const p=products.find(x=>x.id===id); if(!p) return; editId=id;
  $('#pTitle').value=p.title; $('#pType').value=p.type; $('#pPrice').value=p.price.toFixed(2); $('#pDesc').value=p.desc||'';
  $('#prevFront').src=p.imgFront||''; $('#prevBack').src=p.imgBack||''; $('#prevAlt1').src=p.alt1||''; $('#prevAlt2').src=p.alt2||'';
  window.scrollTo({top:0,behavior:'smooth'});
}
function deleteProduct(id){
  if(confirm('Delete this product?')){
    products = products.filter(x=>x.id!==id);
    saveProducts(); render(); renderAdmin();
  }
}

/* ------- Store grid ------- */
function filterProducts(key,btn){ filterKey=key; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn?.classList.add('active'); render(); }
function render(){
  const grid=$('#grid'); grid.innerHTML='';
  const list = filterKey==='all'? products : products.filter(p=>p.type===filterKey);
  if(!list.length){ grid.innerHTML='<div class="card"><div class="pad">No items yet.</div></div>'; return; }

  list.forEach(p=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="card-head" data-id="${p.id}">
        <div class="sides">
          <div class="side front"><img src="${p.imgFront||LOGO}" alt="${p.title} - Front"></div>
          <div class="side back"><img src="${p.imgBack||LOGO}"  alt="${p.title} - Back"></div>
        </div>
        <button class="flipBtn" onclick="toggleFlip(event,'${p.id}')">Flip</button>
      </div>
      <div class="pad">
        <div class="item-title">${p.title}</div>
        <div class="price">${fmt(p.price)}</div>
        <div class="row">
          <button class="btn" onclick="viewProduct('${p.id}')">View</button>
          <button class="btn primary" onclick="addToCart('${p.id}')">Add</button>
        </div>
      </div>`;
    grid.appendChild(card);
  });
}
function toggleFlip(e,id){
  e.stopPropagation();
  const head = document.querySelector(`.card-head[data-id="${id}"]`);
  head.parentElement.classList.toggle('flipped');
}
function viewProduct(id){
  const p=products.find(x=>x.id===id); if(!p) return;
  alert(p.title + '\n\n' + (p.desc||''));
}

/* ------- Cart & totals (discounts updated) ------- */
function loadCart(){ try{ cart=JSON.parse(localStorage.getItem(K.CART)||'[]'); }catch{ cart=[]; } updateCartCount(); }
function saveCart(){ try{ localStorage.setItem(K.CART,JSON.stringify(cart)); }catch{} updateCartCount(); }
function updateCartCount(){ $('#cartCount').textContent = cart.reduce((t,i)=>t+(i.qty||1),0); }

function addToCart(id){
  const p=products.find(x=>x.id===id); if(!p) return;
  const i=cart.findIndex(x=>x.id===id);
  if(i>-1) cart[i].qty += 1; else cart.push({id:p.id,title:p.title,price:p.price,img:p.imgFront,qty:1});
  saveCart(); go('#cart'); renderCart();
}
function removeFromCart(idx){ cart.splice(idx,1); saveCart(); renderCart(); }
function clearCart(){ if(confirm('Clear entire cart?')){ cart=[]; saveCart(); renderCart(); } }

function calcTotals(){
  let cents=0; cart.forEach(i=>cents += Math.round(i.price*100)*(i.qty||1));
  // DISCOUNTS: ≥$130 → 10%, ≥$200 → 20%
  let disc=0; if(cents>=20000) disc=Math.round(cents*0.20); else if(cents>=13000) disc=Math.round(cents*0.10);
  const taxBase = Math.max(0,cents-disc), tax = Math.round(taxBase*0.06), grand=taxBase+tax;
  return {sub:cents/100, disc:disc/100, tax:tax/100, grand:grand/100};
}
function renderCart(){
  const list=$('#cartList'); list.innerHTML='';
  if(cart.length===0){ list.innerHTML='<p>Your cart is empty.</p>'; $('#subtotal').textContent='$0.00';$('#discount').textContent='$0.00';$('#tax').textContent='$0.00';$('#grand').textContent='$0.00'; return; }
  cart.forEach((i,idx)=>{
    const row=document.createElement('div'); row.className='cart-item';
    row.innerHTML = `<img src="${i.img||LOGO}" alt="">
      <div class="grow"><div><strong>${i.title}</strong></div><div class="small">${i.qty} × ${fmt(i.price)}</div></div>
      <button class="btn" onclick="removeFromCart(${idx})">Remove</button>`;
    list.appendChild(row);
  });
  const t=calcTotals(); $('#subtotal').textContent=fmt(t.sub); $('#discount').textContent='-'+fmt(t.disc); $('#tax').textContent=fmt(t.tax); $('#grand').textContent=fmt(t.grand);
  renderPayPalButtons(t.grand);
}

/* ------- PayPal ------- */
function renderPayPalButtons(total){
  const host = $('#paypal-buttons'); host.innerHTML='';
  if(!window.paypal || cart.length===0) return;
  paypal.Buttons({
    style:{layout:'vertical',color:'gold',shape:'pill'},
    createOrder: (data, actions)=> actions.order.create({
      purchase_units: [{
        amount:{ value: total.toFixed(2), currency_code:'USD' },
        items: cart.map(i=>({name:i.title,quantity:i.qty,unit_amount:{value:i.price.toFixed(2),currency_code:'USD'}}))
      }]
    }),
    onApprove: (data, actions)=> actions.order.capture().then(()=>{
      cart=[]; saveCart(); renderCart(); alert('Thank you! Your vinyl therapy is on its way.');
    }),
    onError: err=>{ console.error(err); alert('Payment error.'); }
  }).render('#paypal-buttons');
}

/* ------- Admin overlay ------- */
function adminPortal(){
  const pass=prompt('Enter admin password:');
  if(pass==='vinyltherapy') showAdmin(); else if(pass) alert('Access denied.');
}
function showAdmin(){ $('#admin').classList.add('show'); renderAdmin(); renderHeroManager(); }
function hideAdmin(){ $('#admin').classList.remove('show'); }
function renderAdmin(){
  const list=$('#adminList'); list.innerHTML='';
  products.forEach(p=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center;flex:1">
        <img src="${p.imgFront||LOGO}" style="width:40px;height:40px;border-radius:8px;object-fit:cover">
        <div><strong>${p.title}</strong><div class="small">${p.type} • ${fmt(p.price)}</div></div>
      </div>
      <button class="btn" onclick="editProduct('${p.id}')">Edit</button>
      <button class="btn" onclick="deleteProduct('${p.id}')">Delete</button>`;
    list.appendChild(row);
  });
}

/* ------- Hero manager ------- */
function loadHero(){
  try{ activeHero = localStorage.getItem(K.HERO)||LOGO; }catch{ activeHero=LOGO; }
  try{ heroImages = JSON.parse(localStorage.getItem(K.HERO_IMGS)||'[]'); }catch{ heroImages=[]; }
  $('#heroLogo').innerHTML=`<img src="${activeHero}" style="width:100%;height:100%;object-fit:cover">`;
}
function saveHero(){
  try{ localStorage.setItem(K.HERO, activeHero); localStorage.setItem(K.HERO_IMGS, JSON.stringify(heroImages)); }catch{}
}
function addHeroFromFile(){
  const f=$('#heroPicker').files?.[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=e=>{ heroImages.unshift(e.target.result); activeHero=e.target.result; saveHero(); renderHeroManager(); $('#heroLogo').innerHTML=`<img src="${activeHero}" style="width:100%;height:100%;object-fit:cover">`}; rd.readAsDataURL(f);
}
function renderHeroManager(){
  $('#heroActiveThumb').src=activeHero||LOGO;
  const strip=$('#heroStrip'); strip.innerHTML='';
  const all=[activeHero, ...heroImages.filter(x=>x!==activeHero)];
  all.forEach(src=>{
    const box=document.createElement('div'); box.style.cssText='width:180px;background:#0b1322;border:1px solid #273246;border-radius:10px;padding:10px';
    box.innerHTML = `<img src="${src}" style="width:100%;height:110px;object-fit:cover;border-radius:8px;margin-bottom:8px">
      <div style="display:flex;gap:8px"><button class="btn primary" style="flex:1">Make Active</button><button class="btn" style="flex:1">Delete</button></div>`;
    const [make,del]=box.querySelectorAll('button');
    make.onclick=()=>{ activeHero=src; saveHero(); renderHeroManager(); $('#heroLogo').innerHTML=`<img src="${activeHero}" style="width:100%;height:100%;object-fit:cover">`; };
    del.onclick=()=>{ heroImages=heroImages.filter(h=>h!==src); if(activeHero===src){ activeHero=LOGO; } saveHero(); renderHeroManager(); };
    strip.appendChild(box);
  });
}

/* ------- Kitty portal (5 taps) ------- */
function kittyTap(){
  taps++; if(tapTimer) clearTimeout(tapTimer);
  tapTimer=setTimeout(()=>{taps=0},8000);
  if(taps>=5){ taps=0; adminPortal(); }
}

/* ------- Radio controls ------- */
function buildStationPills(){
  const wrap=$('#stationPills'); wrap.innerHTML='';
  STATIONS.forEach((s,i)=>{
    const b=document.createElement('button'); b.className='radio-pill'+(i===currentStation?' active':'');
    b.textContent=s.name; b.onclick=()=>setStation(i,true); wrap.appendChild(b);
  });
  updateNowPlaying();
}
function ytUrl(id,autoplay){
  return `https://www.youtube.com/embed/${id}?autoplay=${autoplay?1:0}&modestbranding=1&rel=0&playsinline=1`;
}
function setStation(i,userGesture){
  currentStation=i; document.querySelectorAll('.radio-pill').forEach((el,idx)=>el.classList.toggle('active',idx===i));
  const f=$('#ytFrame'); f.src = ytUrl(STATIONS[i].id, userGesture && isPlaying);
  updateNowPlaying();
}
function updateNowPlaying(){
  $('#npText').textContent = STATIONS[currentStation].name;
  $('#npTopText').textContent = STATIONS[currentStation].name;
  $('#npTop').style.display = isPlaying ? 'inline' : 'none';
}
function togglePlay(){
  isPlaying=!isPlaying;
  $('#playBtn').textContent = isPlaying ? '⏸' : '▶';
  const f=$('#ytFrame'); f.src = ytUrl(STATIONS[currentStation].id, isPlaying);
  updateNowPlaying();
}
function cycleStation(){ setStation( (currentStation+1)%STATIONS.length, true ); if(isPlaying) togglePlay(), togglePlay(); }

/* ------- Backup / Import ------- */
function backup(){
  const blob=new Blob([JSON.stringify({products,heroImages,activeHero},null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kdr-backup.json'; a.click();
}
function importBackup(){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=x=>{
      try{
        const data=JSON.parse(x.target.result);
        if(Array.isArray(data.products)) products=data.products;
        if(Array.isArray(data.heroImages)) heroImages=data.heroImages;
        if(data.activeHero) activeHero=data.activeHero;
        saveProducts(); saveHero(); render(); renderAdmin(); renderHeroManager();
        alert('Import complete');
      }catch{ alert('Bad backup file'); }
    };
    rd.readAsText(f);
  };
  inp.click();
}

/* ------- Init ------- */
(function init(){
  loadProducts(); loadCart(); loadHero(); render(); buildStationPills(); setStation(0,false); route();
})();
</script>
</body>
</html>
