<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3b2aa2"/>
  <meta name="description" content="KornDog Records - Hand-picked vinyl, Funkos & collectibles for music lovers and pop culture enthusiasts. Vinyl therapy always on deck."/>
  <title>KornDog Records â€¢ Vinyl Therapy & Collectibles</title>
  
  <!-- Web App Manifest for PWA score -->
  <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiS29ybkRvZyBSZWNvcmRzIiwic2hvcnRfbmFtZSI6Iktvcm5Eb2ciLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiMzYjJhYTIiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBiMTQyMCIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHZpZXdCb3g9JzAgMCA5NiA5NiclM0UlM0NjaXJjbGUgY3g9JzQ4JyBjeT0nNDgnIHI9JzQ0JyBmaWxsPSclMjNhNzhiZmEnLyUzRSUzQ3RleHQgeD0nNDgnIHk9JzU2JyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXNpemU9JzI0JyBmaWxsPSd3aGl0ZSclM0UlRjAlOUYlOEUlQjUlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  
  <style>
    :root{
      --bg1:#3b2aa2;--bg2:#0fa77f;--ink:#eaf4ff;--muted:#b6c2d1;--card:#0b1220;
      --green:#16a34a;--green2:#22c55e;--accent:#ffd166;--shadow:0 4px 12px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{font-size:16px}
    body{
      font-family:system-ui,sans-serif;color:var(--ink);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      background-attachment:fixed;min-height:100vh;padding-bottom:60px;
    }
    img{max-width:100%;height:auto;display:block}
    .btn{
      background:#0e1624;border:1px solid #253146;color:#d7e3f4;border-radius:8px;
      padding:8px 12px;cursor:pointer;font-size:14px;transition:background .15s ease;
    }
    .btn:hover{background:#151f31}
    .btn:focus{outline:2px solid var(--accent);outline-offset:2px}
    .btn.primary{background:var(--green);border-color:var(--green);color:#fff}
    .btn.primary:hover{background:var(--green2)}
    .badge{
      background:#121827;color:#a3d2ff;border-radius:12px;padding:2px 6px;
      margin-left:4px;font-size:12px;
    }

    .nav{
      position:sticky;top:0;z-index:50;background:rgba(11,18,32,.9);
      backdrop-filter:blur(4px);border-bottom:1px solid rgba(255,255,255,.1);
      padding:10px 16px;display:flex;justify-content:space-between;align-items:center;
    }
    .brand{font-weight:700;color:var(--accent);font-size:18px}
    .links{display:flex;gap:8px;align-items:center}
    .links a,.links button{
      padding:6px 8px;border-radius:6px;background:transparent;color:var(--ink);
      transition:background .15s;text-decoration:none;border:none;cursor:pointer;
    }
    .links a:hover,.links button:hover{background:rgba(255,255,255,.1)}

    .page{display:none}
    .page.active{display:block}
    .container{max-width:1200px;margin:0 auto;padding:16px}

    /* Hero - optimized for performance */
    .hero{
      min-height:80vh;display:grid;place-items:center;text-align:center;
      padding:32px 16px;
    }
    .hero-logo{
      width:240px;height:240px;border-radius:50%;margin:0 auto 20px;
      background:linear-gradient(135deg,#a78bfa,#4ade80);
      display:grid;place-items:center;font-size:64px;
      border:3px solid rgba(255,255,255,.3);box-shadow:var(--shadow);
    }
    .hero h1{font-size:clamp(32px,6vw,48px);margin:0 0 12px;font-weight:800}
    .sub{opacity:.9;font-size:18px;margin-bottom:20px;max-width:600px}

    /* Radio on home - simplified for performance */
    .home-radio{
      background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.2);
      border-radius:12px;padding:16px;margin:20px auto;max-width:500px;
      backdrop-filter:blur(4px);
    }
    .radio-header{display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:12px}
    .radio-controls{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .radio-btn{
      background:#182238;border:1px solid #2b3850;border-radius:20px;
      padding:6px 12px;font-size:13px;color:#dfe7f7;cursor:pointer;
      transition:all .15s;
    }
    .radio-btn.active{background:#ffd166;color:#111}
    .play-btn{
      width:40px;height:40px;border-radius:50%;background:#111a2b;
      color:#fff;border:1px solid #384a6a;cursor:pointer;
      display:grid;place-items:center;font-size:16px;transition:background .15s;
    }
    .play-btn:hover{background:#1a2540}

    /* Store - optimized grid */
    .store-header{
      display:flex;justify-content:space-between;align-items:center;
      flex-wrap:wrap;gap:12px;margin-bottom:16px;
    }
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{
      background:#0f1729;border:1px solid #273043;color:#d7e3f4;
      border-radius:6px;padding:6px 10px;cursor:pointer;font-size:13px;
      transition:background .15s;
    }
    .tab.active,.tab:hover{background:#172136}

    .grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:14px;
    }
    .card{
      background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.1);
      border-radius:12px;overflow:hidden;transition:transform .2s ease;
    }
    .card:hover{transform:translateY(-2px)}
    .card-img{
      height:160px;background:#0b1220;position:relative;overflow:hidden;
      display:grid;place-items:center;
    }
    .card-img img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
    .flip-btn{
      position:absolute;top:6px;right:6px;background:rgba(0,0,0,.7);
      color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;
      border:1px solid rgba(255,255,255,.3);cursor:pointer;
    }
    .card-content{padding:12px}
    .card-title{font-weight:700;margin:0 0 4px;font-size:18px;line-height:1.3}
    .card-price{color:#c4e6ff;margin:4px 0 8px;font-weight:600}
    .card-actions{display:flex;gap:6px}

    /* Cart drawer - minimal */
    .drawer{
      position:fixed;top:0;right:-400px;width:400px;max-width:95vw;height:100vh;
      background:#0c1423;color:#eaf4ff;border-left:1px solid #253146;
      transition:right .25s ease;display:flex;flex-direction:column;z-index:60;
    }
    .drawer.open{right:0}
    .drawer-header{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px;border-bottom:1px solid #223045;
    }
    .drawer-main{flex:1;overflow:auto;padding:12px}
    .drawer-footer{border-top:1px solid #223045;padding:12px}
    .cart-item{
      display:flex;gap:10px;border:1px solid #223045;border-radius:8px;
      padding:10px;margin-bottom:8px;background:rgba(255,255,255,.02);
    }
    .cart-item img{width:40px;height:40px;border-radius:6px;object-fit:cover}

    /* Admin - streamlined */
    .admin{
      position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:80;
    }
    .admin.show{display:block}
    .admin-panel{
      position:absolute;right:0;top:0;width:100%;max-width:900px;height:100%;
      background:#0b1220;border-left:1px solid #223045;overflow:auto;
    }
    .admin-header{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px;border-bottom:1px solid #223045;
    }
    .admin-body{padding:12px;display:grid;gap:12px}
    .admin-card{
      background:#0e1628;border:1px solid #223145;border-radius:10px;padding:12px;
    }
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .form-group{margin:8px 0}
    .form-group label{display:block;font-size:12px;margin-bottom:4px;color:#cfe0ff}
    .form-group input,.form-group select,.form-group textarea{
      width:100%;background:#0b1322;border:1px solid #273246;color:#e6f1ff;
      border-radius:6px;padding:6px;font-size:14px;
    }
    .photo-row{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:8px 0}
    .photo-box{
      background:#0b1322;border:1px solid #273246;border-radius:8px;
      padding:8px;text-align:center;cursor:pointer;
    }
    .photo-preview{
      width:100%;height:80px;border-radius:6px;background:#0b1220;
      display:grid;place-items:center;overflow:hidden;margin-bottom:4px;
    }
    .photo-preview img{width:100%;height:100%;object-fit:cover}

    /* Toast - lightweight */
    .toast{
      position:fixed;bottom:80px;left:12px;display:none;align-items:center;
      gap:8px;z-index:70;
    }
    .toast.show{display:flex;animation:slideIn .2s ease}
    .toast-icon{
      width:50px;height:50px;border-radius:50%;background:#a7f3d0;
      display:grid;place-items:center;font-size:24px;
    }
    .toast-msg{
      background:#fff;color:#111;border-radius:12px;padding:8px 12px;
      font-weight:600;font-size:14px;
    }
    @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}

    /* About panel */
    .about-panel{
      background:linear-gradient(140deg,#ff4da0,#22cc88);padding:16px;
      border-radius:12px;color:#fff;box-shadow:var(--shadow);
    }

    /* Bottom bar - ultra minimal */
    .bottom-bar{
      position:fixed;bottom:0;left:0;right:0;background:rgba(11,20,31,.9);
      border-top:1px solid #202b3c;padding:6px 12px;z-index:55;
      display:flex;align-items:center;gap:6px;backdrop-filter:blur(4px);
    }
    .station-btn{
      background:#182238;border:1px solid #2b3850;border-radius:16px;
      padding:4px 8px;font-size:11px;color:#dfe7f7;cursor:pointer;
    }
    .station-btn.active{background:#ffd166;color:#111}
    .radio-info{margin-left:auto;color:#ffd166;font-size:11px;font-weight:600}

    /* Modal - minimal */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;
      align-items:center;justify-content:center;z-index:200;
    }
    .modal-content{
      background:#0b1220;border:1px solid #233046;border-radius:10px;
      width:min(800px,95vw);padding:12px;box-shadow:var(--shadow);
    }
    .modal-header{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;
    }
    .video-container{
      position:relative;padding-top:56.25%;background:#000;border-radius:8px;overflow:hidden;
    }
    .video-container iframe{
      position:absolute;inset:0;width:100%;height:100%;border:0;
    }

    /* Responsive */
    @media(max-width:768px){
      .admin-body{grid-template-columns:1fr}
      .drawer{width:100vw}
      .hero-logo{width:200px;height:200px}
      .radio-controls{justify-content:center}
      .store-header{flex-direction:column;align-items:stretch}
    }

    /* Performance optimizations */
    .lazy{opacity:0;transition:opacity .2s ease}
    .lazy.loaded{opacity:1}
    .invisible{visibility:hidden}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- Critical path HTML only -->
  <nav class="nav">
    <div class="brand">ðŸŒ­ KornDog Records</div>
    <div class="links">
      <a href="#home" data-page="home">Home</a>
      <a href="#store" data-page="store">Shop</a>
      <a href="#about" data-page="about">About</a>
      <button data-action="cart">Cart <span id="cartCount" class="badge">0</span></button>
      <button class="btn" data-action="admin">Admin</button>
    </div>
  </nav>

  <main>
    <!-- HOME -->
    <section id="home" class="page active">
      <div class="hero">
        <div class="hero-logo" id="heroLogo">ðŸŽµ</div>
        <h1>Vinyl Therapy Always On Deck</h1>
        <p class="sub">Hand-picked records, Funkos & collectibles for music lovers and pop culture enthusiasts.</p>
        
        <div class="home-radio">
          <div class="radio-header">
            <h3 style="font-size:16px;font-weight:600">ðŸŽ§ Radio Stations</h3>
            <button class="btn" data-action="radio-modal">Full Player</button>
          </div>
          <div class="radio-controls">
            <div class="play-btn" id="homePlay">â–¶</div>
            <button class="radio-btn active" data-station="0">Metalcore</button>
            <button class="radio-btn" data-station="1">Miku</button>
            <button class="radio-btn" data-station="2">DGD</button>
          </div>
          <div style="text-align:center;margin-top:8px;font-size:13px;color:#9fb4c9">
            Now: <span id="currentStation">Metalcore Meltdown</span>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:center;margin-top:16px">
          <button class="btn primary" data-page="store">Enter The Shop</button>
          <button class="btn" data-page="about">About</button>
        </div>
      </div>
    </section>

    <!-- STORE -->
    <section id="store" class="page">
      <div class="container">
        <div class="store-header">
          <h2 style="font-size:24px;font-weight:700">Explore Our Collections</h2>
          <div class="tabs">
            <button class="tab active" data-filter="all">All</button>
            <button class="tab" data-filter="vinyl">Vinyl</button>
            <button class="tab" data-filter="cd">CDs</button>
            <button class="tab" data-filter="funko">Funkos</button>
            <button class="tab" data-filter="collectible">Collectibles</button>
          </div>
        </div>
        <div id="productGrid" class="grid"></div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="page">
      <div class="container">
        <div class="about-panel">
          <h2>About Me (Korndog Records)</h2>
          <p>Music's always been in my blood â€” thanks to my mom and dad â€” but vinyl didn't hit me 'til after my mom's wreck. She didn't make it. That moment split my world in two. Records became therapy. No therapist. No pills. Just needle to groove. It grounded me.</p>
          <p>Every spin pulls me back â€” riding shotgun with my old man, laughing with my kids, slow dancing with my wife. This site? It's not about algorithms or fake hype. It's about soul, stories, and memories you can hear. If you get it, you get it. Welcome to Korndog Records â€” where vinyl therapy is always on deck.</p>
          <h3>Zombie Kitty Story</h3>
          <p>Zombie Kitty isn't just a mascot â€” she's family. Born from a Friday the 13th tattoo session with my daughter Elizabeth â€” purple rose eye, stitched-up smile â€” part nightmare, part love letter. A reminder that scars can be art, and that vinyl never truly dies. Every play brings it back to life.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
            <a class="btn primary" target="_blank" href="https://www.discogs.com/user/korndog0804" rel="noopener">ðŸŽµ Discogs</a>
            <a class="btn primary" target="_blank" href="https://whatnot.com/s/OisexUo7" rel="noopener">ðŸ“º Whatnot</a>
            <button class="btn" data-action="admin">ðŸ”’ Admin</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- CART DRAWER -->
  <aside id="cartDrawer" class="drawer">
    <div class="drawer-header">
      <strong>Your Cart</strong>
      <button class="btn" data-action="close-cart">Close</button>
    </div>
    <div class="drawer-main" id="cartItems"></div>
    <div class="drawer-footer">
      <div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:8px">
        <span>Subtotal:</span><strong id="subtotal">$0.00</strong>
        <span>Discount:</span><span id="discount">$0.00</span>
        <span>Tax (6%):</span><span id="tax">$0.00</span>
        <span style="font-weight:700">Total:</span><strong id="total">$0.00</strong>
      </div>
      <div id="paypalContainer"></div>
      <button class="btn" style="width:100%;margin-top:8px" data-action="clear-cart">Clear Cart</button>
    </div>
  </aside>

  <!-- ADMIN MODAL -->
  <div id="adminModal" class="admin">
    <div class="admin-panel">
      <div class="admin-header">
        <strong>Admin Panel</strong>
        <div style="display:flex;gap:6px">
          <button class="btn" data-action="cleanup">ðŸ§¹ Cleanup</button>
          <button class="btn" data-action="backup">Backup</button>
          <button class="btn" data-action="import">Import</button>
          <button class="btn" data-action="close-admin">Close</button>
        </div>
      </div>
      <div class="admin-body">
        <div class="admin-card">
          <h3>Add / Edit Product</h3>
          <form id="productForm">
            <div class="form-group">
              <label>Title</label>
              <input id="prodTitle" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Category</label>
                <select id="prodType" required>
                  <option value="vinyl">Vinyl</option>
                  <option value="cd">CD</option>
                  <option value="funko">Funko</option>
                  <option value="collectible">Collectible</option>
                </select>
              </div>
              <div class="form-group">
                <label>Price ($)</label>
                <input id="prodPrice" type="number" step="0.01" required>
              </div>
            </div>
            <div class="photo-row">
              <div class="photo-box" data-photo="front">
                <div class="photo-preview"><img id="imgFront" alt="Front"></div>
                <input type="file" accept="image/*" class="hidden">
                <span>Front</span>
              </div>
              <div class="photo-box" data-photo="back">
                <div class="photo-preview"><img id="imgBack" alt="Back"></div>
                <input type="file" accept="image/*" class="hidden">
                <span>Back</span>
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="prodDesc" rows="2"></textarea>
            </div>
            <div style="display:flex;gap:6px">
              <button type="submit" class="btn primary">Save</button>
              <button type="button" class="btn" data-action="reset-form">Reset</button>
            </div>
          </form>
        </div>
        <div class="admin-card">
          <h3>Inventory</h3>
          <div id="adminInventory"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RADIO MODAL -->
  <div id="radioModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <strong>ðŸŽ§ Radio Player</strong>
        <button class="btn" data-action="close-radio">Close</button>
      </div>
      <div class="video-container">
        <iframe id="radioFrame" src="" allow="autoplay; encrypted-media" allowfullscreen loading="lazy"></iframe>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">
    <div class="toast-icon">ðŸ˜º</div>
    <div class="toast-msg" id="toastMsg">Done!</div>
  </div>

  <!-- BOTTOM BAR -->
  <div class="bottom-bar">
    <button class="station-btn active" data-bottom-station="0">Metalcore</button>
    <button class="station-btn" data-bottom-station="1">Miku</button>
    <button class="station-btn" data-bottom-station="2">DGD</button>
    <span class="radio-info">â™ª <span id="bottomNow">Metalcore</span></span>
    <button class="btn" style="padding:4px 6px;font-size:11px" data-action="radio-modal">Player</button>
  </div>

  <!-- Deferred PayPal SDK for better performance -->
  <script>
    window.addEventListener('load', () => {
      if(document.querySelector('#paypalContainer').innerHTML === ''){
        const script = document.createElement('script');
        script.src = 'https://www.paypal.com/sdk/js?client-id=AcU9sSdlnQlq_dsilwLNL2Kw5YQczqtoEpuYmoADtbJ7be3JaMUXpignQu2RiUcnBEuH_e-edGgSnYv8&currency=USD';
        script.defer = true;
        document.head.appendChild(script);
      }
    });
  </script>

  <script>
    // Ultra-optimized app state and functions
    (function(){
      'use strict';

      // Constants
      const TAX_RATE = 0.06;
      const DISCOUNTS = [{min:130,rate:0.1},{min:200,rate:0.2}];
      const PLACEHOLDER = "data:image/svg+xml,%3Csvg viewBox='0 0 48 48'%3E%3Ccircle cx='24' cy='24' r='20' fill='%23a78bfa'/%3E%3Ctext x='24' y='28' text-anchor='middle' font-size='16' fill='white'%3EðŸ“€%3C/text%3E%3C/svg%3E";
      
      const STATIONS = [
        {name:"Metalcore Meltdown",id:"naNuknf62FY",short:"Metalcore"},
        {name:"Hatsune Miku",id:"2ENM9GVOuAI",short:"Miku"},
        {name:"Dance Gavin Dance",id:"bR7r3uII-x8",short:"DGD"}
      ];

      const MESSAGES = {
        add:["KAPOW! Added!","Holy groove!","Boom! Secured!","By the power of wax!","Bam! Activated!"],
        remove:["Poof! Banished!","Zap! Voided!","Whoosh! Gone!","Another bites dust!"],
        checkout:["Thanks for your order!"]
      };

      // App state
      let products = [];
      let cart = [];
      let filter = 'all';
      let editId = null;
      let station = 0;
      let playing = false;
      let heroLib = [];
      let heroActive = '';

      // Cache DOM elements
      const els = {};
      function cacheElements(){
        const selectors = {
          cartCount:'#cartCount', productGrid:'#productGrid', cartItems:'#cartItems',
          subtotal:'#subtotal', discount:'#discount', tax:'#tax', total:'#total',
          toast:'#toast', toastMsg:'#toastMsg', cartDrawer:'#cartDrawer',
          adminModal:'#adminModal', radioModal:'#radioModal', radioFrame:'#radioFrame',
          currentStation:'#currentStation', bottomNow:'#bottomNow', heroLogo:'#heroLogo',
          productForm:'#productForm', adminInventory:'#adminInventory', paypalContainer:'#paypalContainer'
        };
        Object.entries(selectors).forEach(([key,sel])=> els[key] = document.querySelector(sel));
      }

      // Optimized data persistence
      const storage = {
        save(key, data){
          try{ localStorage.setItem(key, JSON.stringify(data)); }catch(e){}
        },
        load(key, fallback = null){
          try{ 
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : fallback;
          }catch(e){ return fallback; }
        }
      };

      // Batch DOM operations
      function updateUI(){
        requestAnimationFrame(()=>{
          els.cartCount.textContent = cart.reduce((sum,item)=>sum+(item.qty||1),0);
          els.currentStation.textContent = STATIONS[station].name;
          els.bottomNow.textContent = STATIONS[station].short;
          updateStationButtons();
        });
      }

      function updateStationButtons(){
        document.querySelectorAll('[data-station]').forEach((btn,i)=> 
          btn.classList.toggle('active', i === station));
        document.querySelectorAll('[data-bottom-station]').forEach((btn,i)=> 
          btn.classList.toggle('active', i === station));
      }

      // Event delegation for performance
      document.addEventListener('click', e => {
        const action = e.target.dataset.action;
        const page = e.target.dataset.page;
        const filter = e.target.dataset.filter;
        const stationBtn = e.target.dataset.station;
        const bottomStation = e.target.dataset.bottomStation;

        if(page) showPage(page);
        else if(action) handleAction(action, e.target);
        else if(filter) setFilter(filter, e.target);
        else if(stationBtn) setStation(parseInt(stationBtn));
        else if(bottomStation) setStation(parseInt(bottomStation));
      });

      function handleAction(action, target){
        switch(action){
          case 'cart': openCart(); break;
          case 'close-cart': closeCart(); break;
          case 'clear-cart': clearCart(); break;
          case 'admin': adminPortal(); break;
          case 'close-admin': closeAdmin(); break;
          case 'radio-modal': openRadio(); break;
          case 'close-radio': closeRadio(); break;
          case 'cleanup': cleanupProducts(); break;
          case 'backup': backup(); break;
          case 'import': importData(); break;
          case 'reset-form': resetForm(); break;
        }
      }

      function showPage(id){
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        history.replaceState(null, '', '#' + id);
      }

      function setFilter(key, btn){
        filter = key;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        renderProducts();
      }

      function setStation(index){
        station = index;
        updateUI();
        if(playing && els.radioFrame.src) loadRadio();
      }

      // Optimized product rendering with DocumentFragment
      function renderProducts(){
        const grid = els.productGrid;
        const fragment = document.createDocumentFragment();
        
        const filtered = filter === 'all' ? products : products.filter(p => p.type === filter);
        
        if(filtered.length === 0){
          const empty = document.createElement('div');
          empty.className = 'card';
          empty.innerHTML = '<div style="padding:16px">No items yet. Use Admin â†’ Add Product.</div>';
          fragment.appendChild(empty);
        } else {
          filtered.forEach(product => {
            const card = createProductCard(product);
            fragment.appendChild(card);
          });
        }
        
        grid.innerHTML = '';
        grid.appendChild(fragment);
      }

      function createProductCard(p){
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-img">
            <img src="${p.imgFront||PLACEHOLDER}" alt="${p.title}" loading="lazy" class="lazy">
            <button class="flip-btn" onclick="flipImage(this,'${p.imgBack||PLACEHOLDER}')">Flip</button>
          </div>
          <div class="card-content">
            <h3 class="card-title">${p.title}</h3>
            <div class="card-price">$${p.price.toFixed(2)}</div>
            <div class="card-actions">
              <button class="btn" onclick="viewProduct('${p.id}')">View</button>
              <button class="btn primary" onclick="addToCart('${p.id}')">Add</button>
            </div>
          </div>`;
        
        // Lazy load images
        const img = card.querySelector('img');
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if(entry.isIntersecting){
              entry.target.classList.add('loaded');
              observer.unobserve(entry.target);
            }
          });
        });
        observer.observe(img);
        
        return card;
      }

      // Cart functions
      function openCart(){
        els.cartDrawer.classList.add('open');
        renderCart();
      }

      function closeCart(){
        els.cartDrawer.classList.remove('open');
      }

      function addToCart(id){
        const product = products.find(p => p.id === id);
        if(!product) return;
        
        const existing = cart.find(item => item.id === id);
        if(existing) existing.qty += 1;
        else cart.push({id, title:product.title, price:product.price, img:product.imgFront, qty:1});
        
        storage.save('kdr_cart', cart);
        updateUI();
        renderCart();
        showToast('add');
      }

      function removeFromCart(index){
        cart.splice(index, 1);
        storage.save('kdr_cart', cart);
        updateUI();
        renderCart();
        showToast('remove');
      }

      function clearCart(){
        if(confirm('Clear cart?')){
          cart = [];
          storage.save('kdr_cart', cart);
          updateUI();
          renderCart();
        }
      }

      function renderCart(){
        const container = els.cartItems;
        const fragment = document.createDocumentFragment();
        
        cart.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML = `
            <img src="${item.img||PLACEHOLDER}" alt="${item.title}" loading="lazy">
            <div style="flex:1">
              <strong>${item.title}</strong>
              <div style="color:#9fb4c9">${item.qty} Ã— $${item.price.toFixed(2)}</div>
            </div>
            <button class="btn" onclick="removeFromCart(${index})">Remove</button>`;
          fragment.appendChild(div);
        });
        
        container.innerHTML = '';
        container.appendChild(fragment);
        updateTotals();
      }

      function updateTotals(){
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        let discount = 0;
        DISCOUNTS.forEach(d => {
          if(subtotal >= d.min) discount = Math.max(discount, subtotal * d.rate);
        });
        const tax = (subtotal - discount) * TAX_RATE;
        const total = subtotal - discount + tax;

        els.subtotal.textContent = `$${subtotal.toFixed(2)}`;
        els.discount.textContent = `-$${discount.toFixed(2)}`;
        els.tax.textContent = `$${tax.toFixed(2)}`;
        els.total.textContent = `$${total.toFixed(2)}`;
        
        setupPayPal(total);
      }

      // Admin functions
      function adminPortal(){
        const pass = prompt('Enter admin password:');
        if(pass === 'vinyltherapy') openAdmin();
        else if(pass) alert('Access denied.');
      }

      function openAdmin(){
        els.adminModal.classList.add('show');
        renderAdmin();
      }

      function closeAdmin(){
        els.adminModal.classList.remove('show');
      }

      function cleanupProducts(){
        const before = products.length;
        products = products.filter(p => 
          p.imgFront && p.imgFront !== PLACEHOLDER && p.imgFront.length > 100
        );
        const removed = before - products.length;
        if(removed > 0){
          storage.save('kdr_products', products);
          renderProducts();
          renderAdmin();
          alert(`Cleaned up ${removed} invalid products.`);
        } else {
          alert('No cleanup needed.');
        }
      }

      function renderAdmin(){
        const container = els.adminInventory;
        const fragment = document.createDocumentFragment();
        
        products.forEach(p => {
          const div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML = `
            <img src="${p.imgFront||PLACEHOLDER}" alt="${p.title}" loading="lazy">
            <div style="flex:1">
              <strong>${p.title}</strong>
              <div style="color:#9fb4c9">${p.type} â€¢ $${p.price.toFixed(2)}</div>
            </div>
            <div style="display:flex;gap:4px">
              <button class="btn" onclick="editProduct('${p.id}')">Edit</button>
              <button class="btn" onclick="deleteProduct('${p.id}')">Del</button>
            </div>`;
          fragment.appendChild(div);
        });
        
        container.innerHTML = '';
        container.appendChild(fragment);
      }

      // Radio functions
      function openRadio(){
        els.radioModal.style.display = 'flex';
        if(playing) loadRadio();
      }

      function closeRadio(){
        els.radioModal.style.display = 'none';
      }

      function loadRadio(){
        const url = `https://www.youtube.com/embed/${STATIONS[station].id}?autoplay=1&rel=0&modestbranding=1`;
        els.radioFrame.src = url;
      }

      // Toast system
      function showToast(type){
        const messages = MESSAGES[type] || ['Done!'];
        els.toastMsg.textContent = messages[Math.floor(Math.random() * messages.length)];
        els.toast.classList.add('show');
        setTimeout(() => els.toast.classList.remove('show'), 2000);
      }

      // PayPal integration
      function setupPayPal(amount){
        if(!window.paypal || cart.length === 0) return;
        
        els.paypalContainer.innerHTML = '';
        try{
          paypal.Buttons({
            style:{layout:'vertical',color:'gold',shape:'pill'},
            createOrder(data, actions){
              return actions.order.create({
                purchase_units:[{
                  amount:{value:amount.toFixed(2),currency_code:'USD'},
                  items:cart.map(item=>({
                    name:item.title,quantity:item.qty,
                    unit_amount:{value:item.price.toFixed(2),currency_code:'USD'}
                  }))
                }],
                application_context:{shipping_preference:'NO_SHIPPING'}
              });
            },
            onApprove(data, actions){
              return actions.order.capture().then(()=>{
                cart = [];
                storage.save('kdr_cart', cart);
                closeCart();
                updateUI();
                showToast('checkout');
                alert('Thank you for your order!');
              });
            },
            onError(err){
              console.error('PayPal error:', err);
              alert('Payment failed. Please try again.');
            }
          }).render('#paypalContainer');
        }catch(e){
          console.error('PayPal setup failed:', e);
        }
      }

      // Global functions (needed for inline handlers)
      window.flipImage = function(btn, backImg){
        const img = btn.parentNode.querySelector('img');
        const current = img.dataset.side || 'front';
        img.style.opacity = '0.5';
        setTimeout(() => {
          img.src = current === 'front' ? backImg : img.dataset.originalSrc || img.src;
          img.dataset.side = current === 'front' ? 'back' : 'front';
          if(!img.dataset.originalSrc) img.dataset.originalSrc = img.src;
          img.style.opacity = '1';
        }, 150);
      };

      window.viewProduct = function(id){
        const p = products.find(x => x.id === id);
        if(p) alert(`${p.title}\n\n${p.desc || 'No description'}`);
      };

      window.addToCart = function(id){ addToCart(id); };
      window.removeFromCart = function(i){ removeFromCart(i); };
      window.editProduct = function(id){ /* admin function */ };
      window.deleteProduct = function(id){ /* admin function */ };

      // Initialize app
      function init(){
        cacheElements();
        
        // Load data
        products = storage.load('kdr_products', []);
        cart = storage.load('kdr_cart', []);
        heroLib = storage.load('kdr_hero_lib', []);
        heroActive = storage.load('kdr_hero', '');
        
        // Filter invalid products
        products = products.filter(p => p && p.id && p.title);
        
        // Set hero image
        if(heroActive && heroActive.length > 50){
          els.heroLogo.innerHTML = `<img src="${heroActive}" style="width:100%;height:100%;object-fit:cover" alt="Hero">`;
        }
        
        // Initial render
        renderProducts();
        updateUI();
        setStation(0);
      }

      // Hash routing
      function handleRoute(){
        const page = location.hash.slice(1) || 'home';
        if(['home','store','about'].includes(page)) showPage(page);
        if(page === 'cart') openCart();
      }

      window.addEventListener('hashchange', handleRoute);
      
      // Initialize when DOM is ready
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      // Handle route on load
      handleRoute();

    })();
  </script>
</body>
</html>
