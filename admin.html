<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KornDog Admin — Mark Sold</title>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0620; color:#eae6ff; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:16px; }
    h1 { margin: 0 0 10px; font-size: 22px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin: 12px 0; }
    button { cursor:pointer; border:0; border-radius: 12px; padding: 10px 12px; font-weight: 700; }
    .btn { background:#7bff5a; color:#0b0620; }
    .btn2 { background: transparent; color:#7bff5a; border:1px solid rgba(123,255,90,0.6); }
    .btnDanger { background:#ff4d4d; color:#14060a; }
    input { padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color:#eae6ff; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid rgba(255,255,255,0.10); vertical-align: top; }
    th { font-size: 12px; letter-spacing: .06em; text-transform: uppercase; opacity: .8; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; }
    .ok { background: rgba(123,255,90,0.18); color:#7bff5a; border:1px solid rgba(123,255,90,0.35); }
    .sold { background: rgba(255,77,77,0.18); color:#ff7a7a; border:1px solid rgba(255,77,77,0.35); }
    .small { opacity:.85; font-size: 13px; line-height: 1.4; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; word-break: break-word; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>Korndog Admin — Mark Sold</h1>
        <span class="small" id="status">Locked</span>
      </div>

      <div id="lockBox">
        <p class="small">
          This is a <b>static</b> admin. It can’t auto-edit GitHub — it will generate a new <b>products.json2</b> you download.
        </p>
        <div class="row">
          <input id="pw" type="password" placeholder="Enter admin passphrase" />
          <button class="btn" id="unlockBtn">Unlock</button>
        </div>
        <p class="small">Tip: set your passphrase in the script below (ADMIN_PASSPHRASE).</p>
      </div>

      <div id="app" style="display:none;">
        <div class="row">
          <button class="btn2" id="reloadBtn">Reload products.json2</button>
          <button class="btn" id="downloadBtn">Download updated products.json2</button>
          <button class="btn2" id="copyBtn">Copy JSON to clipboard</button>
          <button class="btnDanger" id="resetBtn">Reset local changes</button>
        </div>

        <div class="row">
          <input id="filter" placeholder="Search (artist/title/id)..." style="flex:1; min-width:240px;" />
        </div>

        <div class="small" id="counts"></div>

        <table>
          <thead>
            <tr>
              <th style="width:110px;">Status</th>
              <th>Item</th>
              <th style="width:120px;">Price</th>
              <th style="width:110px;">Qty</th>
              <th style="width:220px;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>

        <div style="margin-top:12px;">
          <div class="small">Preview of generated JSON (first 2 items):</div>
          <div class="card mono" id="preview" style="margin-top:8px;"></div>
        </div>
      </div>

      <script>
        // =========================
        //  KORNDOG ADMIN (STATIC)
        // =========================
        // ✅ Updates "available" + "quantity"
        // ✅ Generates downloadable products.json2
        // ✅ Stores edits in localStorage until you download/reset
        //
        // IMPORTANT:
        // - This does NOT auto-commit to GitHub.
        // - After download, you upload/commit the new products.json2.
        // =========================

        const PRODUCTS_FILE = "./products.json2";
        const ADMIN_PASSPHRASE = "CHANGE_THIS_TO_SOMETHING_ONLY_YOU_KNOW";
        const LS_KEY = "korndog_admin_products_override_v1";

        let products = [];

        const $ = (id) => document.getElementById(id);

        function isSold(p) {
          const q = Number(p.quantity ?? 1);
          const available = (p.available !== false);
          return (!available) || (q <= 0);
        }

        function normalize(p) {
          return {
            ...p,
            id: p.id ?? "",
            title: p.title ?? "",
            artist: p.artist ?? "",
            price: Number(p.price ?? 0),
            quantity: (typeof p.quantity === "number" ? p.quantity : 1),
            tier: (p.tier ?? "premium"),
          };
        }

        async function loadProductsFresh() {
          const res = await fetch(PRODUCTS_FILE, { cache: "no-store" });
          if (!res.ok) throw new Error("Could not load products.json2");
          const raw = await res.json();
          if (!Array.isArray(raw)) throw new Error("products.json2 must be an array");
          return raw.map(normalize);
        }

        function loadFromLocalOverride() {
          try {
            const raw = localStorage.getItem(LS_KEY);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return null;
            return parsed.map(normalize);
          } catch {
            return null;
          }
        }

        function saveLocalOverride() {
          localStorage.setItem(LS_KEY, JSON.stringify(products, null, 2));
          updatePreview();
        }

        function resetLocalOverride() {
          localStorage.removeItem(LS_KEY);
        }

        function downloadFile(filename, text) {
          const blob = new Blob([text], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

        function updatePreview() {
          const sample = products.slice(0, 2);
          $("preview").textContent = JSON.stringify(sample, null, 2);
        }

        function setStatus(msg) {
          $("status").textContent = msg;
        }

        function render() {
          const rows = $("rows");
          rows.innerHTML = "";

          const query = $("filter").value.trim().toLowerCase();
          const visible = products.filter(p => {
            const hay = `${p.artist} ${p.title} ${p.id}`.toLowerCase();
            return query ? hay.includes(query) : true;
          });

          const soldCount = products.filter(isSold).length;
          $("counts").textContent =
            `Total: ${products.length} • Available: ${products.length - soldCount} • Sold/Hidden: ${soldCount}`;

          visible.forEach((p, idx) => {
            const tr = document.createElement("tr");

            const statusTd = document.createElement("td");
            statusTd.innerHTML = isSold(p)
              ? `<span class="pill sold">SOLD</span>`
              : `<span class="pill ok">LIVE</span>`;

            const itemTd = document.createElement("td");
            itemTd.innerHTML =
              `<div style="font-weight:800;">${escapeHtml(p.artist ? `${p.artist} — ${p.title}` : (p.title || p.id || "Untitled"))}</div>` +
              `<div class="small">ID: <span class="mono">${escapeHtml(p.id || "—")}</span></div>`;

            const priceTd = document.createElement("td");
            priceTd.textContent = `$${Number(p.price || 0).toFixed(2)}`;

            const qtyTd = document.createElement("td");
            qtyTd.innerHTML = `<span class="mono">${Number(p.quantity ?? 1)}</span>`;

            const actionsTd = document.createElement("td");

            const soldBtn = document.createElement("button");
            soldBtn.className = "btnDanger";
            soldBtn.textContent = "Mark Sold";
            soldBtn.onclick = () => {
              // ✅ make it disappear on shop
              p.available = false;
              p.quantity = 0;
              saveLocalOverride();
              render();
            };

            const liveBtn = document.createElement("button");
            liveBtn.className = "btn";
            liveBtn.textContent = "Mark Live";
            liveBtn.style.marginLeft = "8px";
            liveBtn.onclick = () => {
              // ✅ restore to live
              p.available = true;
              p.quantity = Math.max(1, Number(p.quantity ?? 1));
              saveLocalOverride();
              render();
            };

            const setQtyBtn = document.createElement("button");
            setQtyBtn.className = "btn2";
            setQtyBtn.textContent = "Set Qty…";
            setQtyBtn.style.marginLeft = "8px";
            setQtyBtn.onclick = () => {
              const next = prompt("Enter new quantity (0 hides it):", String(p.quantity ?? 1));
              if (next === null) return;
              const n = Math.max(0, Math.floor(Number(next)));
              p.quantity = n;
              p.available = (n > 0);
              saveLocalOverride();
              render();
            };

            actionsTd.appendChild(soldBtn);
            actionsTd.appendChild(liveBtn);
            actionsTd.appendChild(setQtyBtn);

            tr.appendChild(statusTd);
            tr.appendChild(itemTd);
            tr.appendChild(priceTd);
            tr.appendChild(qtyTd);
            tr.appendChild(actionsTd);

            rows.appendChild(tr);
          });

          updatePreview();
        }

        function escapeHtml(s) {
          return String(s).replace(/[&<>"']/g, (m) => ({
            "&":"&amp;",
            "<":"&lt;",
            ">":"&gt;",
            '"':"&quot;",
            "'":"&#039;"
          }[m]));
        }

        async function boot() {
          setStatus("Loading…");

          // prefer local override if exists
          const local = loadFromLocalOverride();
          if (local) {
            products = local;
            setStatus("Unlocked • Local edits loaded");
            render();
            return;
          }

          products = await loadProductsFresh();
          setStatus("Unlocked • Loaded from products.json2");
          saveLocalOverride(); // store baseline so edits persist
          render();
        }

        $("unlockBtn").onclick = async () => {
          const input = $("pw").value || "";
          if (input !== ADMIN_PASSPHRASE) {
            alert("Nope. Wrong passphrase.");
            return;
          }
          $("lockBox").style.display = "none";
          $("app").style.display = "block";
          await boot();
        };

        $("reloadBtn").onclick = async () => {
          if (!confirm("Reload from products.json2? This will overwrite your local edits.")) return;
          resetLocalOverride();
          products = await loadProductsFresh();
          saveLocalOverride();
          render();
          setStatus("Unlocked • Reloaded fresh");
        };

        $("downloadBtn").onclick = () => {
          const json = JSON.stringify(products, null, 2);
          downloadFile("products.json2", json);
          setStatus("Unlocked • Downloaded products.json2");
          alert("Downloaded. Now upload/commit products.json2 to GitHub and it’ll go live.");
        };

        $("copyBtn").onclick = async () => {
          const json = JSON.stringify(products, null, 2);
          await navigator.clipboard.writeText(json);
          setStatus("Unlocked • Copied JSON");
          alert("Copied to clipboard. Paste it into products.json2 in GitHub.");
        };

        $("resetBtn").onclick = async () => {
          if (!confirm("Reset local changes and reload from products.json2?")) return;
          resetLocalOverride();
          products = await loadProductsFresh();
          saveLocalOverride();
          render();
          setStatus("Unlocked • Reset");
        };

        $("filter").addEventListener("input", render);
      </script>
    </div>
  </div>
</body>
</html>
