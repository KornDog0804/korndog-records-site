<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KornDog Admin</title>
<style>
:root{
  --bg:#050013;--bg2:#2a0a60;--card:rgba(255,255,255,.04);--card2:rgba(0,0,0,.18);
  --border:rgba(255,255,255,.10);--text:#f5f5ff;--muted:#a1a1c5;
  --accent:#7bff5a;--accent2:#7ef7ff;--danger:#ff4b6a;--warn:#ff9f43;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
body{margin:0;min-height:100vh;color:var(--text);background:radial-gradient(circle at top,var(--bg2) 0,var(--bg) 55%)}
a{color:inherit;text-decoration:none}
header{position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);
  background:linear-gradient(to right,rgba(10,1,30,.95),rgba(10,1,25,.9));
  border-bottom:1px solid rgba(123,255,90,.2)}
.nav-inner{max-width:1100px;margin:0 auto;padding:.75rem 1.25rem;display:flex;align-items:center;justify-content:space-between;gap:1rem}
.logo-circle{width:44px;height:44px;border-radius:999px;border:2px solid var(--accent);
  background:radial-gradient(circle at 30% 30%,#5a00ff,#140032);overflow:hidden}
.logo-circle img{width:100%;height:100%;object-fit:cover}
nav{display:flex;align-items:center;gap:.75rem}
.nav-link{padding:.6rem 1.4rem;border-radius:999px;font-size:.92rem;color:var(--muted);border:1px solid transparent;font-weight:600}
.nav-link:hover{border-color:rgba(123,255,90,.6);color:var(--text)}
.nav-link.active{background:var(--accent);color:#02010a;font-weight:900}
main{max-width:1100px;margin:0 auto;padding:1.5rem 1.25rem 3rem}
h1{margin:.25rem 0 .25rem;font-size:2rem;letter-spacing:.02em}
.subtitle{margin:0 0 1.25rem;color:var(--muted);font-size:.95rem}
.section{margin-top:1.25rem;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:1.4rem;
  padding:1.1rem 1.1rem 1.25rem;box-shadow:0 18px 40px rgba(0,0,0,.35)}
.section-title{margin:0 0 .75rem;font-size:1.02rem;letter-spacing:.14em;text-transform:uppercase;color:var(--accent2)}
label{display:block;font-size:.78rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:0 0 .35rem}
input[type="text"],input[type="password"],input[type="number"],textarea,select{
  width:100%;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
  background:rgba(5,0,15,.92);color:var(--text);outline:none;font-size:.95rem}
textarea{border-radius:14px;min-height:90px;resize:vertical;line-height:1.35}
input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(123,255,90,.35)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.field{flex:1;min-width:180px;margin-bottom:10px}
.hint{font-size:.82rem;color:var(--muted);margin-top:.35rem}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;border-radius:999px;border:none;
  font-weight:900;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;font-size:.78rem;white-space:nowrap}
.btn:active{transform:translateY(1px)}
.btn-primary{background:var(--accent);color:#02010a}
.btn-outline{background:transparent;color:var(--accent);border:1px solid rgba(123,255,90,.55)}
.btn-danger{background:var(--danger);color:#fff}
.btn-soft{background:rgba(123,255,90,.16);border:1px solid rgba(123,255,90,.5);color:var(--accent)}
.btn-warn{background:rgba(255,159,67,.18);border:1px solid rgba(255,159,67,.55);color:#ffd4a8}
.btn-row{display:inline-flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.status{margin-top:10px;padding:10px 12px;border-radius:999px;font-size:.85rem;border:1px solid rgba(123,255,90,.35);
  background:rgba(123,255,90,.06);color:var(--accent)}
.status.error{border-color:rgba(255,75,106,.45);background:rgba(255,75,106,.08);color:var(--danger)}
.status.warn{border-color:rgba(255,159,67,.45);background:rgba(255,159,67,.08);color:#ffd4a8}
.inv-toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
.inv-list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
.inv-card{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:var(--card2)}
.inv-thumb{width:78px;height:78px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);overflow:hidden;flex:0 0 auto}
.inv-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.inv-meta{flex:1;min-width:0}
.inv-title{margin:0 0 4px;font-weight:950;font-size:1rem}
.inv-sub{margin:0;color:var(--muted);font-size:.86rem;line-height:1.25}
.badges{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
.badge{font-size:.72rem;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:var(--muted)}
.badge.live{border-color:rgba(123,255,90,.35);color:var(--accent)}
.badge.hidden{border-color:rgba(255,75,106,.35);color:var(--danger)}
.badge.sold{border-color:rgba(255,159,67,.55);color:#ffd4a8}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.pill-row{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
.search-pill{border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.03);color:var(--muted);
  padding:6px 10px;font-size:.78rem;cursor:pointer}
.search-pill:hover{background:rgba(123,255,90,.12);color:var(--accent)}
.checkbox-row{display:flex;align-items:center;gap:8px;margin-top:6px}
.checkbox-row input{width:16px;height:16px}
.hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
@media(max-width:720px){.inv-card{flex-direction:column}.inv-thumb{width:100%;height:auto;aspect-ratio:1/1}}
small.code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:var(--muted)}
</style>
</head>
<body>

<header>
  <div class="nav-inner">
    <a href="index.html" aria-label="Home">
      <div class="logo-circle"><img src="images/Screenshot_20250831-144625.png" alt="KornDog Records logo"/></div>
    </a>
    <nav>
      <a class="nav-link" href="index.html">Home</a>
      <a class="nav-link" href="shop.html">Shop</a>
      <a class="nav-link" href="cart.html">Cart</a>
      <a class="nav-link active" href="admin.html">Admin</a>
    </nav>
  </div>
</header>

<main id="app">
  <h1>KornDog Admin</h1>
  <p class="subtitle">4 sections · Whatnot-style · tiers · <b>products.json2 only</b>. Token required to write.</p>

  <section class="section" id="sec1">
    <div class="section-title">1. GitHub Token</div>
    <div class="field">
      <label for="token">Personal Access Token</label>
      <input id="token" type="password" placeholder="Paste GitHub token (repo contents access)"/>
      <div class="hint">
        Token stays on <b>this device only</b> (localStorage). You can clear it anytime.
        <div style="margin-top:6px"><small class="code">Needs repo contents write access for: KornDog0804/korndog-records-site</small></div>
      </div>
    </div>
    <div class="btn-row">
      <button id="btnSaveToken" class="btn btn-outline" type="button">Set / Change Token</button>
      <button id="btnRefresh" class="btn btn-soft" type="button">Refresh Inventory</button>
      <button id="btnClearToken" class="btn btn-danger" type="button">Clear Token</button>
    </div>
    <div id="status" class="status"><span id="statusText">Paste token to enable admin actions…</span></div>
  </section>

  <section class="section" id="sec2">
    <div class="section-title">2. Add / Edit A Record</div>
    <div class="hint" id="editHint" style="display:none;margin-bottom:10px"><b>EDIT MODE:</b> Updating an existing record. ID is locked.</div>

    <form id="form">
      <div class="field">
        <label for="rid">Record ID / PID (type anything)</label>
        <input id="rid" type="text" placeholder="commodores-all-the-great-hits (or type Commodore's — we will fix it)"/>
        <div class="hint">
          New records are <b>auto-normalized</b> into a safe <b>pid</b> (lowercase + hyphens). This prevents “Product not found” on share links and makes back photos work.
        </div>
      </div>

      <div class="row">
        <div class="field"><label for="artist">Artist</label><input id="artist" type="text" placeholder="AC/DC"/></div>
        <div class="field"><label for="title">Title</label><input id="title" type="text" placeholder="Back in Black"/></div>
      </div>

      <div class="row">
        <div class="field"><label for="price">Price</label><input id="price" type="number" step="0.01" placeholder="17.99"/></div>
        <div class="field"><label for="grade">Grade</label><input id="grade" type="text" placeholder="NM/NM"/></div>
        <div class="field"><label for="qty">Qty</label><input id="qty" type="number" min="0" value="1"/></div>
      </div>

      <div class="row">
        <div class="field">
          <label for="tier">Tier</label>
          <select id="tier">
            <option value="premium">Premium</option>
            <option value="tenbin">$10 Bin</option>
            <option value="threefor25">3 for $25</option>
            <option value="budget">Budget</option>
            <option value="sealed">Sealed</option>
          </select>
          <div class="hint">Tiers are tags. Price still drives totals on the shop.</div>
        </div>
        <div class="field">
          <label>Visible on Site</label>
          <div class="checkbox-row"><input id="available" type="checkbox" checked/><span class="hint" style="margin:0">Checked = live. Unchecked = hidden.</span></div>
        </div>
      </div>

      <div class="field"><label for="desc">Description</label><textarea id="desc" placeholder="Variant, notes, hype…"></textarea></div>

      <div class="hr"></div>
      <div class="hint">
        <b>Mobile fix:</b> Use <b>Library Picker</b> to choose from Photos. Use <b>Camera</b> only if you want to snap a new one.
        (Some phones force camera first if you only have a capture input.)
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>Front Photo (Library Picker)</label>
          <input id="front" type="file" accept="image/*"/>
          <div class="hint">Required for NEW records. Optional on edits.</div>
        </div>
        <div class="field">
          <label>Front Photo (Camera)</label>
          <input id="frontCam" type="file" accept="image/*" capture="environment"/>
          <div class="hint">Optional camera capture.</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Back/Vinyl Photo (Library Picker)</label>
          <input id="back" type="file" accept="image/*"/>
          <div class="hint">Optional. If missing, shop will use front.</div>
        </div>
        <div class="field">
          <label>Back/Vinyl Photo (Camera)</label>
          <input id="backCam" type="file" accept="image/*" capture="environment"/>
          <div class="hint">Optional camera capture.</div>
        </div>
      </div>

      <div class="btn-row" style="margin-top:14px">
        <button id="btnSave" class="btn btn-primary" type="submit">Save Record</button>
        <button id="btnCancel" class="btn btn-outline" type="button" style="display:none">Cancel Edit</button>
        <button id="btnDel" class="btn btn-danger" type="button" style="display:none">Delete</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Images are auto-compressed to avoid GitHub rejecting large uploads.
      </div>
    </form>
  </section>

  <section class="section" id="sec3">
    <div class="section-title">3. Mark Sold / Back In Stock</div>
    <div class="field">
      <label for="soldSearch">Record ID or Title or Artist</label>
      <input id="soldSearch" type="text" placeholder="Start typing: randy, hendrix, acdc…"/>
      <div class="hint">Type part of artist/title/id and tap a pill.</div>
    </div>
    <div id="soldPills" class="pill-row"></div>
    <div class="row" style="margin-top:10px">
      <div class="field">
        <label for="soldAction">Action</label>
        <select id="soldAction">
          <option value="sold">Save as SOLD (hide & archive)</option>
          <option value="available">Save as AVAILABLE (show & restore)</option>
          <option value="hide">Hide only (available=false)</option>
          <option value="show">Show only (available=true)</option>
        </select>
      </div>
    </div>
    <div class="btn-row">
      <button id="btnSoldSave" class="btn btn-primary" type="button">Save Change to Site</button>
      <button id="btnQuickSold" class="btn btn-danger" type="button">Quick: Mark Sold</button>
      <button id="btnQuickAvail" class="btn btn-soft" type="button">Quick: Mark Available</button>
    </div>
  </section>

  <section class="section" id="sec4">
    <div class="section-title">4. Inventory (View + Edit)</div>
    <div class="inv-toolbar">
      <div class="field" style="margin:0;flex:1;min-width:220px">
        <label for="invSearch">Search</label>
        <input id="invSearch" type="text" placeholder="Search artist, title, id, tier…"/>
      </div>
      <div class="field" style="margin:0;min-width:220px">
        <label for="invFilter">Filter</label>
        <select id="invFilter">
          <option value="live">Live Only</option>
          <option value="all">All (Live + Hidden + Sold)</option>
          <option value="sold">Sold Only</option>
          <option value="hidden">Hidden Only</option>
          <option value="premium">Premium</option>
          <option value="tenbin">$10 Bin</option>
          <option value="threefor25">3 for $25</option>
          <option value="budget">Budget</option>
          <option value="sealed">Sealed</option>
        </select>
      </div>
      <div class="field" style="margin:0;min-width:170px">
        <button id="btnRefresh2" class="btn btn-outline" type="button" style="width:100%">Refresh List</button>
      </div>
    </div>
    <div class="hint" style="margin-top:8px">Tap <b>Edit</b> to load into Section 2, then save.</div>
    <div id="invList" class="inv-list"></div>
  </section>
</main>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const OWNER="KornDog0804", REPO="korndog-records-site", BRANCH="main";
const PRODUCTS_PATH="products.json2";
const IMAGES_FOLDER="images";

/** =========================
 *  DOM + STATUS
 *  ========================= */
const $=id=>document.getElementById(id);
const statusEl=$("status"), statusText=$("statusText");
function setStatus(msg, kind="ok"){
  statusText.textContent=msg;
  statusEl.classList.remove("error","warn");
  if(kind==="error") statusEl.classList.add("error");
  if(kind==="warn")  statusEl.classList.add("warn");
}

/** =========================
 *  TOKEN STORAGE
 *  ========================= */
const TOKEN_KEY="korndog_github_token";
function getToken(){ return localStorage.getItem(TOKEN_KEY) || ""; }
function setToken(v){ localStorage.setItem(TOKEN_KEY, v); }
function clearToken(){ localStorage.removeItem(TOKEN_KEY); }
function requireToken(){
  const t=getToken();
  if(!t){
    setStatus("No GitHub token set. Section 1 first.","error");
    throw new Error("Missing token");
  }
  return t;
}

/** =========================
 *  UTIL
 *  ========================= */
function norm(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]/g,""); }
function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function safeFileName(name){
  return String(name||"image").replace(/[^a-zA-Z0-9_.-]/g,"_");
}
function bytesToBase64(bytes){
  let binary = "";
  const chunkSize = 0x8000;
  for(let i=0;i<bytes.length;i+=chunkSize){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunkSize));
  }
  return btoa(binary);
}
async function textToBase64(text){
  const enc = new TextEncoder().encode(text);
  return bytesToBase64(enc);
}

/** =========================
 *  DUMMY-PROOF PID/ID
 *  - You can type ANYTHING in the ID box.
 *  - For NEW records, we auto-generate a safe pid:
 *    lowercase + hyphens + no apostrophes/spaces.
 *  - We also guarantee uniqueness by adding -2, -3, etc.
 *  - Result: share links + flip backs + product page lookup won't break.
 *  ========================= */
function slugify(raw){
  let s = String(raw || "").trim().toLowerCase();
  // normalize unicode (smart quotes, accents)
  try{ s = s.normalize("NFKD"); }catch(e){}
  s = s
    .replace(/['’`"]/g, "")         // drop quotes/apostrophes
    .replace(/&/g, " and ")         // nicer than empty
    .replace(/[^a-z0-9]+/g, "-")    // non-alnum -> hyphen
    .replace(/^-+|-+$/g, "")        // trim hyphens
    .replace(/-+/g, "-");           // collapse
  if(!s) s = "record";
  return s;
}
function ensureUniquePid(base, products){
  const taken = new Set((products||[]).map(p => String(p.pid || p.id || "").toLowerCase()).filter(Boolean));
  if(!taken.has(base)) return base;
  let n = 2;
  while(taken.has(`${base}-${n}`)) n++;
  return `${base}-${n}`;
}

/** =========================
 *  GITHUB API
 *  - Uses Bearer token (best for fine-grained PATs)
 *  ========================= */
async function github(path, opts={}){
  const token=requireToken();
  const url=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;
  const res=await fetch(url,{
    method: opts.method || "GET",
    headers:{
      "Authorization": "Bearer " + token,
      "Accept": "application/vnd.github+json",
      "Content-Type": "application/json",
      ...(opts.headers||{})
    },
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });

  if(!res.ok){
    const txt=await res.text().catch(()=>"(no body)");
    console.error("GitHub error", res.status, txt);
    let msg = "GitHub API " + res.status;
    if(res.status===401) msg = "Token rejected (401). Wrong token or expired.";
    if(res.status===403) msg = "Blocked (403). Token lacks permissions or rate-limited.";
    if(res.status===404) msg = "Not found (404). Repo/branch/path wrong.";
    if(res.status===422) msg = "Unprocessable (422). File too large or invalid request.";
    throw new Error(msg);
  }
  return res.json();
}

async function getFile(path){
  const d=await github(path);
  const content = String(d.content||"").replace(/\n/g,"");
  const bytes = Uint8Array.from(atob(content), c => c.charCodeAt(0));
  const text = new TextDecoder().decode(bytes);
  return { text, sha: d.sha };
}

async function putText(path, text, message, sha){
  const content = await textToBase64(text);
  const body = { message, content, branch: BRANCH };
  if(sha) body.sha = sha;
  return github(path, { method:"PUT", body });
}

async function putBase64(path, b64, message, sha){
  const body = { message, content: b64, branch: BRANCH };
  if(sha) body.sha = sha;
  return github(path, { method:"PUT", body });
}

/** =========================
 *  IMAGE COMPRESSION
 *  - Prevents GitHub rejecting big phone photos
 *  ========================= */
async function compressImageToJpegBase64(file, maxW=1400, maxH=1400, quality=0.86){
  const img = await new Promise((resolve, reject)=>{
    const i = new Image();
    i.onload=()=>resolve(i);
    i.onerror=reject;
    i.src = URL.createObjectURL(file);
  });

  let { width:w, height:h } = img;
  const scale = Math.min(1, maxW / w, maxH / h);
  w = Math.max(1, Math.round(w * scale));
  h = Math.max(1, Math.round(h * scale));

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, w, h);

  // Always JPEG for smaller size; GitHub likes it
  const dataUrl = canvas.toDataURL("image/jpeg", quality);
  URL.revokeObjectURL(img.src);

  // Return base64 portion only
  return dataUrl.slice(dataUrl.indexOf(",")+1);
}

async function uploadImage(file){
  const safe = Date.now()+"-"+safeFileName(file.name);
  const path = IMAGES_FOLDER + "/" + safe;

  // compress for GitHub size limits
  const b64 = await compressImageToJpegBase64(file);

  // Try upload; if GitHub still complains, reduce quality once
  try{
    await putBase64(path, b64, "Add image " + safe);
  }catch(e){
    console.warn("Upload failed, retry lower quality:", e.message);
    const b64smaller = await compressImageToJpegBase64(file, 1200, 1200, 0.78);
    await putBase64(path, b64smaller, "Add image " + safe);
  }
  return path;
}

/** =========================
 *  PRODUCTS LOAD/SAVE
 *  ========================= */
async function loadProducts(){
  try{
    const { text, sha } = await getFile(PRODUCTS_PATH);
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error("products.json2 not array");
    arr.forEach(p=>{
      if(p.quantity==null) p.quantity=1;
      if(p.available==null) p.available=true;
      if(p.tier==null) p.tier="premium";
      if(p.sold==null) p.sold=false;

      // keep pid present for older records where possible
      if(!p.pid && p.id) p.pid = String(p.id);
    });
    return { products: arr, sha };
  }catch(e){
    console.warn("loadProducts fallback", e.message);
    return { products: [], sha: undefined };
  }
}

async function saveProducts(products, sha, msg){
  await putText(PRODUCTS_PATH, JSON.stringify(products,null,2), msg, sha);
}

/** =========================
 *  STATE
 *  ========================= */
let cache = null;
let editMode = { active:false, id:"" };

async function refresh(){
  const { products } = await loadProducts();
  cache = products;
  return products;
}
async function getProducts(){
  if(!cache) await refresh();
  return cache;
}

/** =========================
 *  TOKEN UI
 *  ========================= */
(function initTokenUI(){
  const t=getToken();
  if(t){
    $("token").value="";
    $("token").placeholder="Token already saved (•••" + t.slice(-6) + ")";
    setStatus("Token already saved on this device. Refresh inventory when ready.");
  }else{
    setStatus("Paste token to enable admin actions…","warn");
  }
})();

$("btnSaveToken").onclick=async()=>{
  const v=$("token").value.trim();
  if(!v){
    setStatus("Paste a token first.","warn");
    return;
  }
  setToken(v);
  $("token").value="";
  $("token").placeholder="Token saved (•••" + v.slice(-6) + ")";
  setStatus("Token saved. Refreshing inventory…");
  try{
    await refresh();
    await renderInventory();
    setStatus("Inventory refreshed ✅");
  }catch(e){
    console.error(e);
    setStatus("Token saved but refresh failed: " + e.message,"error");
  }
};

$("btnClearToken").onclick=()=>{
  clearToken();
  cache=null;
  $("token").value="";
  $("token").placeholder="Paste GitHub token (repo contents access)";
  $("invList").innerHTML="";
  setStatus("Token cleared on this device.","warn");
};

$("btnRefresh").onclick=async()=>{
  try{ requireToken(); }catch{ return; }
  setStatus("Refreshing…");
  try{
    await refresh();
    await renderInventory();
    setStatus("Inventory refreshed ✅");
  }catch(e){
    console.error(e);
    setStatus("Refresh failed: " + e.message, "error");
  }
};
$("btnRefresh2").onclick=$("btnRefresh").onclick;

/** =========================
 *  EDIT MODE
 *  ========================= */
function enterEditMode(p){
  editMode={active:true,id:(p.pid||p.id)};
  $("editHint").style.display="block";
  $("btnCancel").style.display="inline-flex";
  $("btnDel").style.display="inline-flex";
  $("btnSave").textContent="Save Update";

  // Show the locked pid/id
  $("rid").value=(p.pid||p.id||"");
  $("rid").disabled=true;

  $("artist").value=p.artist||"";
  $("title").value=p.title||"";
  $("price").value=(p.price!=null?p.price:"");
  $("grade").value=p.grade||"";
  $("qty").value=(p.quantity!=null?p.quantity:1);
  $("tier").value=p.tier||"premium";
  $("available").checked=(p.available!==false);
  $("desc").value=p.description||"";

  // clear file inputs
  $("front").value="";
  $("frontCam").value="";
  $("back").value="";
  $("backCam").value="";

  $("sec2").scrollIntoView({behavior:"smooth",block:"start"});
  setStatus("Editing: " + (p.artist?p.artist+" — ":"") + (p.title||(p.pid||p.id)));
}

function exitEditMode(){
  editMode={active:false,id:""};
  $("editHint").style.display="none";
  $("btnCancel").style.display="none";
  $("btnDel").style.display="none";
  $("btnSave").textContent="Save Record";
  $("form").reset();
  $("qty").value=1;
  $("tier").value="premium";
  $("available").checked=true;
  $("rid").disabled=false;
  setStatus("Ready for a new record.");
}
$("btnCancel").onclick=exitEditMode;

/** choose file preference:
 *  if library has file use it, else camera file */
function pickFile(libInputId, camInputId){
  const lib = $(libInputId).files && $(libInputId).files[0];
  const cam = $(camInputId).files && $(camInputId).files[0];
  return lib || cam || null;
}

/** =========================
 *  SAVE RECORD
 *  ========================= */
$("form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  try{ requireToken(); }catch{ return; }

  const rawIdInput=$("rid").value.trim();
  const artist=$("artist").value.trim();
  const title=$("title").value.trim();
  const price=parseFloat($("price").value);
  const grade=$("grade").value.trim();
  const quantity=parseInt($("qty").value||"0",10);
  const tier=$("tier").value||"premium";
  const available=!!$("available").checked;
  const description=$("desc").value.trim();

  const frontFile = pickFile("front","frontCam");
  const backFile  = pickFile("back","backCam");

  if(!artist||!title||!grade||Number.isNaN(price)){
    setStatus("Missing: Artist, Title, Price, Grade.","error");
    return;
  }
  if(!editMode.active && !frontFile){
    setStatus("Front photo required for NEW records.","error");
    return;
  }

  setStatus(editMode.active ? "Saving update…" : "Uploading + saving…");

  try{
    const { products, sha } = await loadProducts();

    // ===== DUMMY-PROOF PID LOGIC (NEW RECORDS ONLY) =====
    // If you type “Commodore's” or “Johnny Cash Collection”, we convert it to a safe pid.
    // If you leave it blank, we build it from artist + title.
    let pid = rawIdInput;
    if(!editMode.active){
      const baseRaw = pid || (artist + " " + title);
      const base = slugify(baseRaw);
      pid = ensureUniquePid(base, products);
      // write it back to the input so you SEE what got saved
      $("rid").value = pid;
    }else{
      pid = String(rawIdInput || editMode.id || "").trim();
    }

    if(!pid){
      setStatus("ID/PID could not be generated. Type something in the ID box.","error");
      return;
    }

    // Find record by pid OR id (older records)
    const idx = products.findIndex(p => String(p.pid||p.id) === String(pid));
    const existing = (idx>=0?products[idx]:{});
    const sold = !!existing.sold;

    let frontPath = existing.imageFront || existing.image || "";
    let backPath  = existing.imageBack  || frontPath;

    if(frontFile) frontPath = await uploadImage(frontFile);
    if(backFile)  backPath  = await uploadImage(backFile);
    if(!backPath) backPath = frontPath;

    const updated = {
      // IMPORTANT: pid is the bulletproof key for the whole site.
      pid,
      // Keep id = pid too, so ANY code that uses id keeps working.
      id: pid,

      artist, title, price, grade,
      quantity: Number.isFinite(quantity) ? quantity : 0,
      tier, available, description, sold,

      // image fields (compat + clarity)
      image: frontPath,
      imageFront: frontPath,
      imageBack: backPath,

      // Make "images" an ARRAY so flip/product page can reliably use [0] front, [1] back.
      images: [frontPath, backPath],

      // Keep legacy object too (harmless + helps older scripts if any)
      imagesObj: { front: frontPath, back: backPath },

      // Keep what you typed originally for reference (optional; doesn’t break anything)
      originalId: rawIdInput || ""
    };

    if(idx>=0) products[idx] = { ...products[idx], ...updated };
    else products.push(updated);

    products.sort((a,b)=>(a.artist||"").localeCompare(b.artist||"")||(a.title||"").localeCompare(b.title||""));

    await saveProducts(products, sha, (idx>=0 ? "Update record: " : "Add record: ") + pid);

    await refresh();
    await renderInventory();

    setStatus("Saved ✅ " + artist + " — " + title + " (pid: " + pid + ")");

    if(editMode.active){
      const fresh = await getProducts();
      const rec = fresh.find(r=>String(r.pid||r.id)===String(pid));
      if(rec) enterEditMode(rec);
    }else{
      $("form").reset();
      $("qty").value=1;
      $("tier").value="premium";
      $("available").checked=true;
      // keep pid shown after save? (nah — clear form)
      $("rid").value="";
    }

  }catch(err){
    console.error(err);
    setStatus("Save failed: " + err.message, "error");
  }
});

/** =========================
 *  DELETE
 *  ========================= */
$("btnDel").onclick=async()=>{
  try{ requireToken(); }catch{ return; }
  if(!editMode.active) return;
  if(!confirm("Delete this record?")) return;

  const pid=$("rid").value.trim();
  setStatus("Deleting…");

  try{
    const { products, sha } = await loadProducts();
    await saveProducts(
      products.filter(p=>String(p.pid||p.id)!==String(pid)),
      sha,
      "Delete record: " + pid
    );
    await refresh();
    await renderInventory();
    exitEditMode();
    setStatus("Deleted ✅ " + pid);
  }catch(e){
    console.error(e);
    setStatus("Delete failed: " + e.message, "error");
  }
};

/** =========================
 *  SOLD SEARCH + ACTIONS
 *  ========================= */
$("soldSearch").addEventListener("input", async ()=>{
  $("soldPills").innerHTML="";
  const term=norm($("soldSearch").value.trim());
  if(!term) return;
  try{ requireToken(); }catch{ return; }

  const list=await getProducts();
  list.filter(p=>norm(p.pid||p.id).includes(term)||norm(p.artist).includes(term)||norm(p.title).includes(term))
      .slice(0,10)
      .forEach(p=>{
        const b=document.createElement("button");
        b.type="button";
        b.className="search-pill";
        b.textContent=(p.artist?p.artist+" — ":"")+(p.title||(p.pid||p.id));
        b.onclick=()=>{
          $("soldSearch").value=(p.pid||p.id);
          $("soldPills").innerHTML="";
          setStatus("Selected: "+(p.artist?p.artist+" — ":"")+(p.title||(p.pid||p.id)));
        };
        $("soldPills").appendChild(b);
      });
});

async function applySoldAction(mode){
  const raw=$("soldSearch").value.trim();
  const q=norm(raw);
  if(!q){ setStatus("Type something in Section 3.","error"); return; }
  try{ requireToken(); }catch{ return; }

  setStatus("Saving change to products.json2…");

  try{
    const { products, sha } = await loadProducts();
    const idx = products.findIndex(p=>norm(p.pid||p.id).includes(q)||norm(p.artist).includes(q)||norm(p.title).includes(q));
    if(idx<0){ setStatus("No match for: "+raw,"error"); return; }

    const p=products[idx];
    if(mode==="sold"){ p.sold=true; p.available=false; }
    if(mode==="available"){ p.sold=false; p.available=true; }
    if(mode==="hide"){ p.available=false; }
    if(mode==="show"){ p.available=true; }

    await saveProducts(products, sha, "Update status: " + (p.pid||p.id||p.title));
    await refresh();
    await renderInventory();

    $("soldSearch").value="";
    $("soldPills").innerHTML="";
    setStatus("Done ✅ Updated: " + (p.artist?p.artist+" — ":"") + (p.title||(p.pid||p.id)));

  }catch(e){
    console.error(e);
    setStatus("Could not update: " + e.message, "error");
  }
}

$("btnSoldSave").onclick=()=>applySoldAction($("soldAction").value);
$("btnQuickSold").onclick=()=>applySoldAction("sold");
$("btnQuickAvail").onclick=()=>applySoldAction("available");

/** =========================
 *  INVENTORY RENDER
 *  ========================= */
function badge(text,cls){ return `<span class="badge ${cls||""}">${escapeHtml(text)}</span>`; }
function getThumb(p){ return p.imageFront||p.image||""; }

function passesFilter(p){
  const f=$("invFilter").value;
  if(f==="all") return true;
  if(f==="live") return (p.available!==false)&&!p.sold;
  if(f==="sold") return !!p.sold;
  if(f==="hidden") return (p.available===false)&&!p.sold;
  return (p.tier||"premium")===f;
}
function passesSearch(p){
  const q=norm($("invSearch").value.trim());
  if(!q) return true;
  return norm(p.pid||p.id).includes(q)||norm(p.artist).includes(q)||norm(p.title).includes(q)||norm(p.tier).includes(q);
}

async function renderInventory(){
  $("invList").innerHTML="";
  try{ requireToken(); }catch{ return; }

  const list=await getProducts();
  const filtered=list.filter(p=>passesFilter(p)&&passesSearch(p));

  if(!filtered.length){
    const d=document.createElement("div");
    d.className="hint";
    d.textContent="No matches. Try another search/filter.";
    $("invList").appendChild(d);
    return;
  }

  filtered.slice(0,300).forEach(p=>{
    const thumb=getThumb(p);
    const live=(p.available!==false);
    const sold=!!p.sold;

    const imgSrc=thumb || ("data:image/svg+xml;charset=utf-8,"+encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300">
        <rect width="100%" height="100%" fill="#1a1030"/>
        <text x="50%" y="50%" fill="#a1a1c5" font-size="18" font-family="Arial"
          text-anchor="middle" dominant-baseline="middle">No Image</text>
      </svg>`
    ));

    const pid = (p.pid||p.id||"");

    const card=document.createElement("div");
    card.className="inv-card";
    card.innerHTML=`
      <div class="inv-thumb"><img src="${imgSrc}" alt="${escapeHtml((p.artist?p.artist+" — ":"")+(p.title||pid||"Record"))}"></div>
      <div class="inv-meta">
        <p class="inv-title">${escapeHtml((p.artist?p.artist+" — ":"")+(p.title||pid||"Unknown"))}</p>
        <p class="inv-sub">PID: ${escapeHtml(pid)} · $${escapeHtml(p.price??"")} · ${escapeHtml(p.grade||"")} · Qty: ${escapeHtml(p.quantity??0)}</p>
        <div class="badges">
          ${sold ? badge("SOLD","sold") : (live ? badge("LIVE","live") : badge("HIDDEN","hidden"))}
          ${badge("Tier: "+(p.tier||"premium"))}
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" type="button">Edit</button>
        <button class="btn btn-danger" type="button">Mark Sold</button>
        <button class="btn btn-soft" type="button">Mark Available</button>
      </div>`;

    const btns=card.querySelectorAll("button");
    btns[0].onclick=()=>enterEditMode(p);
    btns[1].onclick=()=>{ $("soldSearch").value=pid; applySoldAction("sold"); };
    btns[2].onclick=()=>{ $("soldSearch").value=pid; applySoldAction("available"); };

    $("invList").appendChild(card);
  });
}

$("invSearch").addEventListener("input",()=>renderInventory().catch(()=>{}));
$("invFilter").addEventListener("change",()=>renderInventory().catch(()=>{}));

/** =========================
 *  BOOT
 *  ========================= */
(async function boot(){
  if(!getToken()){
    setStatus("Paste token to enable admin actions…","warn");
    return;
  }
  try{
    await refresh();
    await renderInventory();
    setStatus("Admin loaded. Live inventory ready.");
  }catch(e){
    console.warn(e);
    setStatus("Auto-load failed: " + e.message, "error");
  }
})();
</script>
</body>
</html>
