<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Korndog Admin</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b0620;color:#e9e9ff;margin:0;padding:16px}
    .wrap{max-width:900px;margin:0 auto}
    h1{margin:0 0 12px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;margin:12px 0}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:#fff;box-sizing:border-box}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{border:0;border-radius:999px;padding:12px 16px;font-weight:800;cursor:pointer}
    .primary{background:#8dff6a;color:#10200f}
    .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25)}
    .danger{background:#ff4d4d;color:#2a0a0a}
    .muted{opacity:.8;font-size:.92rem}
    pre{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;overflow:auto}
    .toggle{display:flex;align-items:center;gap:10px;margin-top:10px}
    .toggle input{width:auto}
    .preview{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .preview img{width:160px;height:160px;object-fit:cover;border-radius:14px;border:1px solid rgba(255,255,255,.15);background:#000}
    .small{font-size:.85rem;opacity:.85}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(141,255,106,.15);border:1px solid rgba(141,255,106,.35);margin-left:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Korndog Admin <span class="pill">JSON Builder</span></h1>
    <div class="muted">
      This page **does not upload to GitHub by itself** (Netlify static site).  
      It builds clean JSON + file paths so you can upload images to `/images` and replace `products.json` without phone-splicing pain.
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">1) Add / Build a Product</h2>

      <div class="row">
        <div>
          <label>Artist</label>
          <input id="artist" placeholder="Various Artists" />
        </div>
        <div>
          <label>Title</label>
          <input id="title" placeholder="Compilation Album - 50 Years of Hip-Hop" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Price (USD)</label>
          <input id="price" type="number" step="0.01" placeholder="39.99" />
        </div>
        <div>
          <label>Grade</label>
          <input id="grade" placeholder="NM/NM" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Quantity</label>
          <input id="quantity" type="number" step="1" value="1" />
        </div>
        <div>
          <label>ID (auto-generated, you can edit)</label>
          <input id="id" placeholder="auto-generated" />
          <div class="small">Tip: keep IDs unique. Use dashes only.</div>
        </div>
      </div>

      <label>Description</label>
      <textarea id="description" placeholder="Short punchy description..."></textarea>

      <div class="toggle">
        <input id="hasBack" type="checkbox" />
        <label for="hasBack" style="margin:0;font-weight:800">Has back photo (special editions)</label>
      </div>

      <div class="row">
        <div>
          <label>Front photo (choose from phone)</label>
          <input id="frontFile" type="file" accept="image/*" />
          <div class="small">This uses the file name as-is. Upload that exact file to `/images` in GitHub.</div>
        </div>
        <div id="backWrap" style="display:none">
          <label>Back photo</label>
          <input id="backFile" type="file" accept="image/*" />
          <div class="small">Upload this exact file name to `/images` too.</div>
        </div>
      </div>

      <div class="preview" id="preview"></div>

      <div class="btns">
        <button class="primary" id="addBtn">Add to Draft List</button>
        <button class="ghost" id="copyOneBtn">Copy JSON Entry</button>
        <button class="ghost" id="clearFormBtn">Clear Form</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">2) Draft Products (what will become products.json)</h2>
      <div class="muted">These are stored in your phone/browser (local). You can download the full JSON when ready.</div>

      <div class="btns">
        <button class="primary" id="downloadBtn">Download products.json</button>
        <button class="ghost" id="copyAllBtn">Copy Full products.json</button>
        <button class="danger" id="wipeBtn">Wipe Draft List</button>
      </div>

      <pre id="allOut">[]</pre>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px">3) Quick sanity checks</h2>
      <ul>
        <li><b>No comments</b> in JSON. Ever. (No <code>//</code> or <code>/* */</code>)</li>
        <li>Image paths must start with <code>images/</code> and match the uploaded file name <b>exactly</b>.</li>
        <li>If you check “Has back photo”, the product will include <code>imageFront</code> + <code>imageBack</code>.</li>
      </ul>
    </div>
  </div>

<script>
  const STORAGE_KEY = "korndog_admin_draft_products_v1";

  const $ = (id) => document.getElementById(id);

  const el = {
    artist: $("artist"),
    title: $("title"),
    price: $("price"),
    grade: $("grade"),
    quantity: $("quantity"),
    id: $("id"),
    description: $("description"),
    hasBack: $("hasBack"),
    frontFile: $("frontFile"),
    backFile: $("backFile"),
    backWrap: $("backWrap"),
    preview: $("preview"),
    allOut: $("allOut"),
    addBtn: $("addBtn"),
    copyOneBtn: $("copyOneBtn"),
    downloadBtn: $("downloadBtn"),
    copyAllBtn: $("copyAllBtn"),
    wipeBtn: $("wipeBtn"),
    clearFormBtn: $("clearFormBtn"),
  };

  function slugify(str) {
    return String(str || "")
      .toLowerCase()
      .trim()
      .replace(/['"]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "")
      .slice(0, 80);
  }

  function getDraft() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    } catch {
      return [];
    }
  }

  function saveDraft(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list, null, 2));
    renderDraft();
  }

  function buildProductFromForm() {
    const artist = el.artist.value.trim();
    const title = el.title.value.trim();
    const price = Number(el.price.value || 0);
    const grade = el.grade.value.trim();
    const quantity = Number(el.quantity.value || 1);
    const description = el.description.value.trim();

    const frontName = el.frontFile.files?.[0]?.name || "";
    const backName = el.backFile.files?.[0]?.name || "";

    const baseId = el.id.value.trim() || slugify(`${artist}-${title}`) || slugify(title) || "new-record";
    const id = slugify(baseId);

    // Always require front image
    const imageFrontPath = frontName ? `images/${frontName}` : "";
    const imageBackPath = backName ? `images/${backName}` : "";

    const p = {
      id,
      artist,
      title,
      price: Number.isFinite(price) ? price : 0,
      grade,
      image: imageFrontPath, // keep legacy support
      description,
      quantity: Number.isFinite(quantity) ? quantity : 1,
      available: true,
    };

    // If user checked "has back", include imageFront/imageBack
    if (el.hasBack.checked) {
      p.imageFront = imageFrontPath;
      p.imageBack = imageBackPath;
    }

    // Clean: remove empty optional fields
    Object.keys(p).forEach((k) => {
      if (p[k] === "" || p[k] === null || p[k] === undefined) delete p[k];
    });

    return p;
  }

  function renderDraft() {
    const list = getDraft();
    el.allOut.textContent = JSON.stringify(list, null, 2);
  }

  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      alert("Copied.");
    } catch {
      alert("Copy failed. (Some phones block clipboard.) Long-press the JSON and copy it manually.");
    }
  }

  function downloadFile(filename, content) {
    const blob = new Blob([content], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function updatePreview() {
    el.preview.innerHTML = "";

    const f = el.frontFile.files?.[0];
    const b = el.backFile.files?.[0];

    if (f) {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(f);
      img.title = "Front";
      el.preview.appendChild(img);
    }
    if (el.hasBack.checked && b) {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(b);
      img.title = "Back";
      el.preview.appendChild(img);
    }
  }

  // ---- Events ----
  function autoIdIfEmpty() {
    const artist = el.artist.value.trim();
    const title = el.title.value.trim();
    if (!el.id.value.trim() && (artist || title)) {
      el.id.value = slugify(`${artist}-${title}`) || slugify(title);
    }
  }

  el.artist.addEventListener("input", autoIdIfEmpty);
  el.title.addEventListener("input", autoIdIfEmpty);

  el.hasBack.addEventListener("change", () => {
    el.backWrap.style.display = el.hasBack.checked ? "block" : "none";
    updatePreview();
  });

  el.frontFile.addEventListener("change", updatePreview);
  el.backFile.addEventListener("change", updatePreview);

  el.addBtn.addEventListener("click", () => {
    const p = buildProductFromForm();

    if (!p.artist || !p.title) {
      alert("Add Artist + Title first.");
      return;
    }
    if (!p.image) {
      alert("Pick a FRONT photo first.");
      return;
    }
    if (el.hasBack.checked && !p.imageBack) {
      alert("You checked back photo — pick the BACK photo too.");
      return;
    }

    const list = getDraft();
    const existsIndex = list.findIndex(x => x.id === p.id);

    if (existsIndex >= 0) {
      const ok = confirm("That ID already exists in draft. Replace it?");
      if (!ok) return;
      list[existsIndex] = p;
    } else {
      list.push(p);
    }

    saveDraft(list);
    alert("Added to draft list.");
  });

  el.copyOneBtn.addEventListener("click", () => {
    const p = buildProductFromForm();
    copyText(JSON.stringify(p, null, 2));
  });

  el.copyAllBtn.addEventListener("click", () => {
    const list = getDraft();
    copyText(JSON.stringify(list, null, 2));
  });

  el.downloadBtn.addEventListener("click", () => {
    const list = getDraft();
    downloadFile("products.json", JSON.stringify(list, null, 2));
  });

  el.wipeBtn.addEventListener("click", () => {
    const ok = confirm("Wipe the entire draft list?");
    if (!ok) return;
    saveDraft([]);
  });

  el.clearFormBtn.addEventListener("click", () => {
    el.artist.value = "";
    el.title.value = "";
    el.price.value = "";
    el.grade.value = "";
    el.quantity.value = "1";
    el.id.value = "";
    el.description.value = "";
    el.hasBack.checked = false;
    el.backWrap.style.display = "none";
    el.frontFile.value = "";
    el.backFile.value = "";
    el.preview.innerHTML = "";
  });

  // init
  renderDraft();
</script>
</body>
</html>
