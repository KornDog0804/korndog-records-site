<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KornDog Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #3b0b78, #050014);
      color: #f9f9ff;
      padding: 16px;
    }
    .wrap {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 8px;
    }
    .tagline {
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 24px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #3a3a6a;
      background: #0c0618;
      color: #f9f9ff;
      box-sizing: border-box;
      margin-bottom: 14px;
      font-size: 0.9rem;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .btn {
      display: inline-block;
      width: 100%;
      text-align: center;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: #a4ff3b;
      color: #050014;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      margin-top: 4px;
    }
    .btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .secondary {
      background: transparent;
      border: 1px solid #a4ff3b;
      color: #a4ff3b;
      margin-top: 12px;
    }
    .status {
      margin-top: 12px;
      font-size: 0.85rem;
      padding: 8px 10px;
      border-radius: 8px;
      background: #120825;
    }
    .status.ok { color: #a4ff3b; }
    .status.err { color: #ff6b81; }
    .field-row {
      display: flex;
      gap: 10px;
    }
    .field-row > div {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>KornDog Admin</h1>
    <div class="tagline">Whatnot-style upload · No more JSON headaches</div>

    <div id="status" class="status">Waiting for input…</div>

    <button class="btn secondary" id="setTokenBtn">Set / Change GitHub Token</button>

    <form id="recordForm">
      <label>Artist / ID (no spaces, e.g. acdc-backinblack)</label>
      <input id="id" required />

      <label>Title (what the customer sees)</label>
      <input id="title" required />

      <div class="field-row">
        <div>
          <label>Price (e.g. 17.99)</label>
          <input id="price" type="number" step="0.01" required />
        </div>
        <div>
          <label>Grade (e.g. NM/NM)</label>
          <input id="grade" required />
        </div>
      </div>

      <label>Description</label>
      <textarea id="description"></textarea>

      <label>Cover Photo</label>
      <input id="imageFile" type="file" accept="image/*" required />

      <button type="submit" class="btn" id="saveBtn">Save to Site</button>
    </form>
  </div>

  <script>
    // ===== CONFIG – CHANGE THESE TO MATCH YOUR REPO =====
    const GITHUB_OWNER = "KornDog0804";
    const GITHUB_REPO = "korndog-records-site";
    const PRODUCTS_PATH = "products.json";
    const IMAGES_FOLDER = "images"; // existing folder

    const statusEl = document.getElementById("status");
    const saveBtn = document.getElementById("saveBtn");
    const setTokenBtn = document.getElementById("setTokenBtn");

    function setStatus(msg, type = "") {
      statusEl.textContent = msg;
      statusEl.className = "status " + (type || "");
    }

    function getToken() {
      return localStorage.getItem("kd_github_token") || "";
    }

    function requireToken() {
      let token = getToken();
      if (!token) {
        token = prompt("Paste your GitHub personal access token (it will be stored only on this device):");
        if (token) {
          localStorage.setItem("kd_github_token", token.trim());
        }
      }
      return token;
    }

    setTokenBtn.addEventListener("click", () => {
      const t = prompt("Paste new GitHub token:");
      if (t) {
        localStorage.setItem("kd_github_token", t.trim());
        setStatus("Token updated on this device.", "ok");
      }
    });

    // Convert File → base64 (no header)
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result.split(",")[1]; // strip data:...;base64,
          resolve(result);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function githubGet(path) {
      const token = requireToken();
      if (!token) throw new Error("No token set.");
      const res = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`, {
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: "application/vnd.github+json"
        }
      });
      if (!res.ok) throw new Error(`GitHub GET ${path} failed: ${res.status}`);
      return res.json();
    }

    async function githubPut(path, contentBase64, message, sha) {
      const token = requireToken();
      if (!token) throw new Error("No token set.");
      const body = {
        message,
        content: contentBase64
      };
      if (sha) body.sha = sha;
      const res = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: "application/vnd.github+json"
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`GitHub PUT ${path} failed: ${res.status} ${txt}`);
      }
      return res.json();
    }

    async function handleSubmit(e) {
      e.preventDefault();
      try {
        saveBtn.disabled = true;
        setStatus("Uploading image…");

        const id = document.getElementById("id").value.trim();
        const title = document.getElementById("title").value.trim();
        const price = parseFloat(document.getElementById("price").value);
        const grade = document.getElementById("grade").value.trim();
        const description = document.getElementById("description").value.trim();
        const file = document.getElementById("imageFile").files[0];

        if (!id || !title || !file || isNaN(price)) {
          throw new Error("Missing required fields.");
        }

        // 1) Upload image file into /images/
        const safeFileName = `${id}-${Date.now()}.jpg`.replace(/[^a-zA-Z0-9._-]/g, "_");
        const imgBase64 = await fileToBase64(file);
        await githubPut(
          `${IMAGES_FOLDER}/${safeFileName}`,
          imgBase64,
          `Add image for ${title}`
        );

        const imagePathForSite = `images/${safeFileName}`; // what products.json will use

        setStatus("Image uploaded. Updating products.json…");

        // 2) Get current products.json from GitHub
        const prodFile = await githubGet(PRODUCTS_PATH);
        const currentJson = atob(prodFile.content);
        const products = JSON.parse(currentJson);

        // 3) Push new record
        products.push({
          id,
          title,
          price,
          grade,
          image: imagePathForSite,
          description
        });

        const newJsonString = JSON.stringify(products, null, 2);
        const newJsonBase64 = btoa(newJsonString);

        // 4) Write products.json back to GitHub
        await githubPut(
          PRODUCTS_PATH,
          newJsonBase64,
          `Add record: ${title}`,
          prodFile.sha
        );

        setStatus("Saved! Netlify will redeploy and the record will show on Shop in a bit.", "ok");
        (e.target).reset();
      } catch (err) {
        console.error(err);
        setStatus("Error: " + err.message, "err");
      } finally {
        saveBtn.disabled = false;
      }
    }

    document.getElementById("recordForm").addEventListener("submit", handleSubmit);
  </script>
</body>
</html>
