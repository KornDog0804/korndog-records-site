<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>KornDog Admin (products.json2 ONLY)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  margin:0;
  font-family: system-ui, sans-serif;
  background:#0b0018;
  color:#f5f5ff;
}
main {
  max-width:1000px;
  margin:auto;
  padding:20px;
}
h1 { margin-bottom:4px; }
h2 { margin-top:30px; color:#7ef7ff; }
.section {
  background:#140028;
  border-radius:14px;
  padding:16px;
  margin-bottom:20px;
}
input, select, textarea {
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
  border:none;
}
button {
  padding:10px 16px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-weight:700;
}
.btn-primary { background:#b8ff4a; color:#05000b; }
.btn-outline { background:transparent; color:#b8ff4a; border:1px solid #b8ff4a; }
.inv-card {
  background:#1c0038;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
}
.badge {
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  margin-right:6px;
}
.badge.premium { background:#7ef7ff; color:#000; }
.badge.tenbin { background:#b8ff4a; color:#000; }
.badge.bundle { background:#ff9f43; color:#000; }
</style>
</head>

<body>
<main>

<h1>KornDog Admin</h1>
<p>Single source of truth · products.json2 only · no bullshit</p>

<!-- TOKEN -->
<section class="section">
<h2>GitHub Token</h2>
<input id="token" placeholder="Paste GitHub token" />
<button class="btn-outline" onclick="saveToken()">Save Token</button>
<p id="status"></p>
</section>

<!-- ADD / EDIT -->
<section class="section">
<h2>Add / Edit Record</h2>

<input id="id" placeholder="unique-id (no spaces)" />
<input id="artist" placeholder="Artist" />
<input id="title" placeholder="Title" />
<input id="price" type="number" step="0.01" placeholder="Price" />
<input id="grade" placeholder="Grade (VG+/VG+)" />
<input id="quantity" type="number" min="0" value="1" />

<select id="tier">
  <option value="premium">Premium</option>
  <option value="tenbin">$10 Bin</option>
  <option value="bundle">Bundle</option>
</select>

<textarea id="description" placeholder="Description"></textarea>

<button class="btn-primary" onclick="saveRecord()">Save Record</button>
</section>

<!-- INVENTORY -->
<section class="section">
<h2>Inventory (Live Edit)</h2>
<input id="search" placeholder="Search…" oninput="renderInventory()" />
<div id="inventory"></div>
</section>

</main>

<script>
const OWNER = "KornDog0804";
const REPO = "korndog-records-site";
const BRANCH = "main";
const PRODUCTS_PATH = "products.json2";

let products = [];
let sha = null;

function setStatus(msg){ document.getElementById("status").textContent = msg; }

function token(){ return localStorage.getItem("gh_token"); }
function saveToken(){
  localStorage.setItem("gh_token", document.getElementById("token").value.trim());
  setStatus("Token saved");
  loadProducts();
}

async function gh(path, method="GET", body){
  const res = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`,
    {
      method,
      headers:{
        Authorization:`token ${token()}`,
        Accept:"application/vnd.github+json"
      },
      body
    }
  );
  if(!res.ok) throw new Error("GitHub error");
  return res.json();
}

async function loadProducts(){
  const file = await gh(PRODUCTS_PATH);
  sha = file.sha;
  products = JSON.parse(atob(file.content));
  renderInventory();
}

function renderInventory(){
  const q = document.getElementById("search").value.toLowerCase();
  const box = document.getElementById("inventory");
  box.innerHTML = "";
  products
    .filter(p =>
      p.artist.toLowerCase().includes(q) ||
      p.title.toLowerCase().includes(q) ||
      p.id.toLowerCase().includes(q)
    )
    .forEach(p=>{
      const div = document.createElement("div");
      div.className="inv-card";
      div.innerHTML = `
        <b>${p.artist} – ${p.title}</b><br>
        $${p.price} · ${p.grade} · Qty ${p.quantity}<br>
        <span class="badge ${p.tier}">${p.tier}</span>
        <br><br>
        <button class="btn-outline" onclick='edit("${p.id}")'>Edit</button>
        <button class="btn-outline" onclick='remove("${p.id}")'>Delete</button>
      `;
      box.appendChild(div);
    });
}

function edit(id){
  const p = products.find(x=>x.id===id);
  Object.keys(p).forEach(k=>{
    const el = document.getElementById(k);
    if(el) el.value = p[k];
  });
}

function remove(id){
  if(!confirm("Delete this record?")) return;
  products = products.filter(p=>p.id!==id);
  saveAll("Delete record");
}

function saveRecord(){
  const p = {
    id: id.value.trim(),
    artist: artist.value.trim(),
    title: title.value.trim(),
    price: +price.value,
    grade: grade.value.trim(),
    quantity: +quantity.value,
    tier: tier.value,
    description: description.value.trim()
  };

  const i = products.findIndex(x=>x.id===p.id);
  if(i>=0) products[i]=p;
  else products.push(p);

  saveAll("Save record");
}

async function saveAll(msg){
  await gh(PRODUCTS_PATH,"PUT",JSON.stringify({
    message:msg,
    content:btoa(JSON.stringify(products,null,2)),
    sha,
    branch:BRANCH
  }));
  loadProducts();
}

if(token()) loadProducts();
</script>
</body>
</html>
