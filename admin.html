<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KornDog Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  margin:0;
  font-family: system-ui, sans-serif;
  background:#0b0018;
  color:#f5f5ff;
}
main {
  max-width:900px;
  margin:auto;
  padding:20px;
}
.section {
  background:#140028;
  border-radius:14px;
  padding:16px;
  margin-bottom:20px;
}
h1,h2 { margin-top:0; }
input,textarea {
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
  border:none;
}
button {
  padding:10px 16px;
  border-radius:999px;
  border:none;
  font-weight:700;
  cursor:pointer;
}
.primary { background:#b8ff4a; color:#05000b; }
.outline { background:transparent; color:#b8ff4a; border:1px solid #b8ff4a; }
.danger { background:#ff5f5f; color:#000; }
.card {
  background:#1c0038;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
}
.badge {
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
}
.live { background:#7ef7ff; color:#000; }
.sold { background:#666; }
</style>
</head>

<body>
<main>

<h1>KornDog Admin</h1>

<section class="section">
<h2>GitHub Token</h2>
<input id="tokenInput" placeholder="Paste GitHub token">
<button class="outline" onclick="saveToken()">Save Token</button>
<p id="status"></p>
</section>

<section class="section">
<h2>Add / Edit Record</h2>
<input id="id" placeholder="unique-id">
<input id="artist" placeholder="Artist">
<input id="title" placeholder="Title">
<input id="price" type="number" step="0.01" placeholder="Price">
<input id="grade" placeholder="Grade (NM/NM)">
<input id="quantity" type="number" min="0" value="1">
<textarea id="description" placeholder="Description"></textarea>
<button class="primary" onclick="saveRecord()">Save Record</button>
</section>

<section class="section">
<h2>Live Inventory</h2>
<input id="search" placeholder="Search..." oninput="render()">
<div id="inventory"></div>
</section>

</main>

<script>
const OWNER = "KornDog0804";
const REPO = "korndog-records-site";
const PATH = "products.json2";
let products = [];
let sha = "";

const $ = id => document.getElementById(id);

function setStatus(msg){ $("status").textContent = msg; }

function saveToken(){
  localStorage.setItem("gh_token", $("tokenInput").value.trim());
  setStatus("Token saved");
  load();
}

function token(){
  return localStorage.getItem("gh_token");
}

async function gh(method, body){
  const res = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`,
    {
      method,
      headers:{
        Authorization:`token ${token()}`,
        Accept:"application/vnd.github+json"
      },
      body
    }
  );
  if(!res.ok) throw new Error("GitHub error");
  return res.json();
}

async function load(){
  const file = await gh("GET");
  sha = file.sha;
  products = JSON.parse(atob(file.content));
  render();
}

function render(){
  const q = $("search").value.toLowerCase();
  $("inventory").innerHTML = "";

  products
    .filter(p => (p.quantity ?? 1) > 0)
    .filter(p =>
      p.artist.toLowerCase().includes(q) ||
      p.title.toLowerCase().includes(q) ||
      p.id.toLowerCase().includes(q)
    )
    .forEach(p=>{
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <b>${p.artist} – ${p.title}</b><br>
        $${p.price} · ${p.grade} · Qty ${p.quantity}<br>
        <span class="badge ${p.quantity>0?'live':'sold'}">
          ${p.quantity>0?'LIVE':'SOLD'}
        </span><br><br>
        <button class="outline" onclick="edit('${p.id}')">Edit</button>
        <button class="outline" onclick="markSold('${p.id}')">Mark Sold</button>
        <button class="danger" onclick="removeRec('${p.id}')">Delete</button>
      `;
      $("inventory").appendChild(div);
    });
}

function edit(id){
  const p = products.find(x=>x.id===id);
  Object.keys(p).forEach(k=>{
    if($(k)) $(k).value = p[k];
  });
}

function markSold(id){
  const p = products.find(x=>x.id===id);
  p.quantity = 0;
  saveAll("Mark sold");
}

function removeRec(id){
  if(!confirm("Delete record?")) return;
  products = products.filter(p=>p.id!==id);
  saveAll("Delete record");
}

function saveRecord(){
  const p = {
    id: id.value.trim(),
    artist: artist.value.trim(),
    title: title.value.trim(),
    price: +price.value,
    grade: grade.value.trim(),
    quantity: +quantity.value,
    description: description.value.trim()
  };
  const i = products.findIndex(x=>x.id===p.id);
  i>=0 ? products[i]=p : products.push(p);
  saveAll("Save record");
}

async function saveAll(msg){
  await gh("PUT", JSON.stringify({
    message: msg,
    content: btoa(JSON.stringify(products,null,2)),
    sha
  }));
  load();
}

if(token()) load();
</script>
</body>
</html>
