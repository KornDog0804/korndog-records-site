<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KornDog Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #5b2cff 0, #120019 40%, #050007 100%);
      color: #f8f8ff;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 2rem 1rem 4rem;
    }
    .admin-shell {
      width: 100%;
      max-width: 720px;
      background: rgba(5, 0, 10, 0.85);
      border-radius: 24px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.6);
      border: 1px solid rgba(168,255,96,0.25);
      padding: 1.75rem 1.5rem 2.25rem;
      backdrop-filter: blur(10px);
    }
    @media (min-width: 768px) {
      .admin-shell { padding: 2.25rem 2.5rem 2.75rem; }
    }
    h1 {
      margin: 0;
      font-size: 2rem;
      letter-spacing: 0.04em;
    }
    .subtitle {
      margin-top: 0.35rem;
      font-size: 0.95rem;
      color: #d9d7ff;
    }
    .subtitle span {
      color: #a8ff60;
      font-weight: 600;
    }
    .status {
      margin-top: 1rem;
      padding: 0.65rem 0.9rem;
      border-radius: 999px;
      font-size: 0.9rem;
      background: rgba(10, 255, 150, 0.08);
      border: 1px solid rgba(168,255,96,0.4);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ffaf3a;
      box-shadow: 0 0 8px rgba(255,175,58,0.9);
    }
    .status.ok .status-dot {
      background: #7fff32;
      box-shadow: 0 0 8px rgba(127,255,50,0.9);
    }
    .status.error {
      border-color: rgba(255,96,96,0.7);
      background: rgba(255,40,80,0.14);
    }
    .status.error .status-dot {
      background: #ff4b6b;
      box-shadow: 0 0 8px rgba(255,75,107,0.9);
    }

    .section-title {
      margin-top: 2rem;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #c4ff95;
    }
    .field-group {
      margin-bottom: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    label {
      font-size: 0.9rem;
      color: #f4f4ff;
    }
    input[type="text"],
    input[type="number"],
    textarea {
      background: rgba(10,0,20,0.9);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 0.6rem 0.9rem;
      font-size: 0.95rem;
      color: #fdfdff;
      outline: none;
      width: 100%;
    }
    textarea {
      border-radius: 14px;
      min-height: 80px;
      resize: vertical;
    }
    input[type="file"] {
      font-size: 0.9rem;
      color: #f4f4ff;
    }
    input::placeholder,
    textarea::placeholder {
      color: #bcb7ff;
    }
    input:focus,
    textarea:focus {
      border-color: #a8ff60;
      box-shadow: 0 0 0 1px rgba(168,255,96,0.45);
    }
    .inline {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .inline .field-group {
      flex: 1 1 120px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.75rem 1.4rem;
      font-weight: 700;
      font-size: 0.98rem;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
    }
    .btn-primary {
      background: linear-gradient(135deg, #a8ff60, #7fff32);
      color: #050208;
      box-shadow: 0 0 16px rgba(168,255,96,0.6);
    }
    .btn-primary:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 0 20px rgba(168,255,96,0.9);
    }
    .btn-secondary {
      background: rgba(75,0,130,0.8);
      color: #f8f8ff;
      border: 1px solid rgba(203,189,255,0.6);
    }
    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 16px rgba(160,120,255,0.6);
    }
    .btn-danger {
      background: linear-gradient(135deg, #ff4b6b, #ff8a6f);
      color: #fff;
      box-shadow: 0 0 16px rgba(255,75,107,0.5);
    }
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 20px rgba(255,75,107,0.8);
    }

    .token-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.6rem;
      margin-bottom: 0.25rem;
      flex-wrap: wrap;
    }
    .token-row input[type="text"] {
      flex: 1 1 200px;
    }
    .hint {
      font-size: 0.82rem;
      color: #b8b3ff;
      margin-bottom: 0.3rem;
    }
    .tiny {
      font-size: 0.75rem;
      opacity: 0.8;
    }
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.35rem;
      font-size: 0.88rem;
    }
    .toggle-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .divider {
      margin: 1.6rem 0 1.25rem;
      border-top: 1px dashed rgba(255,255,255,0.15);
    }
    .id-chip {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(10,10,40,0.9);
      border: 1px solid rgba(255,255,255,0.25);
      display: inline-block;
      margin-top: 0.15rem;
    }

    /* search suggestion pills */
    .search-results {
      margin-top: 0.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    .search-pill {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      padding: 0.25rem 0.6rem;
      font-size: 0.78rem;
      background: rgba(15,5,40,0.95);
      color: #f8f8ff;
      cursor: pointer;
      white-space: nowrap;
    }
    .search-pill:hover {
      border-color: #a8ff60;
      background: rgba(168,255,96,0.12);
    }
  </style>
</head>
<body>
  <div class="admin-shell">
    <header>
      <h1>KornDog Admin</h1>
      <p class="subtitle">
        Whatnot-style upload · <span>No more JSON headaches</span>
      </p>
      <div id="status" class="status">
        <span class="status-dot"></span>
        <span id="status-text">Waiting for input…</span>
      </div>
    </header>

    <!-- GITHUB TOKEN -->
    <section>
      <h2 class="section-title">1. GitHub Token</h2>
      <p class="hint">
        Paste a GitHub personal access token with <strong>repo</strong> access.
        It never leaves your browser – we just use it to talk to GitHub’s API.
      </p>
      <div class="token-row">
        <input type="text" id="token-input" placeholder="ghp_your_personal_access_token_here" />
        <button id="save-token-btn" class="btn btn-secondary">Set / Change GitHub Token</button>
      </div>
      <p class="tiny">
        Stored as <code>korndog_github_token</code> in localStorage.  
        If something gets weird, clear it and paste again.
      </p>
    </section>

    <!-- ADD / EDIT PRODUCT -->
    <section>
      <h2 class="section-title">2. Add a New Record</h2>

      <form id="add-form">
        <div class="field-group">
          <label for="artist-id">
            Artist / ID (no spaces, e.g. <code>acdc-backinblack</code>)
          </label>
          <input id="artist-id" type="text" required placeholder="sleep-token-even-in-arcadia" />
          <span class="tiny">
            This is the <strong>id</strong> in <code>products.json</code>. Keep it unique.
          </span>
        </div>

        <div class="field-group">
          <label for="title">Title (what the customer sees)</label>
          <input id="title" type="text" required placeholder="Sleep Token – Even in Arcadia" />
        </div>

        <div class="inline">
          <div class="field-group">
            <label for="price">Price (e.g. 17.99)</label>
            <input id="price" type="number" step="0.01" min="0" required placeholder="17.99" />
          </div>
          <div class="field-group">
            <label for="grade">Grade (e.g. NM/NM)</label>
            <input id="grade" type="text" required placeholder="NM/NM" />
          </div>
        </div>

        <div class="field-group">
          <label for="description">Description</label>
          <textarea id="description" placeholder="Short hype line – variant, color, story, etc."></textarea>
        </div>

        <div class="field-group">
          <label for="quantity">Stock / Quantity</label>
          <input id="quantity" type="number" min="1" step="1" value="1" />
          <span class="tiny">
            Defaults to 1. For <code>$10 Dolla Holla</code> you can set 3, 5, etc.
          </span>
        </div>

        <div class="field-group">
          <label for="cover">Cover Photo</label>
          <input id="cover" type="file" accept="image/*" required />
          <span class="tiny">
            Will be uploaded to the repo’s <span class="id-chip">images/</span> folder.
          </span>
        </div>

        <div class="toggle-row">
          <input type="checkbox" id="available" checked />
          <label for="available">Available on the site (uncheck to add as hidden / coming soon)</label>
        </div>

        <div style="margin-top: 1.2rem;">
          <button type="submit" class="btn btn-primary">Save to Site</button>
        </div>
      </form>
    </section>

    <div class="divider"></div>

    <!-- TOGGLE SOLD / AVAILABLE -->
    <section>
      <h2 class="section-title">3. Mark Sold / Back in Stock</h2>
      <p class="hint">
        Use the <strong>id</strong> from <code>products.json</code> (same as “Artist / ID” above).  
        Or just type part of the <strong>artist</strong> or <strong>title</strong> and tap a pill.
        Example:
        <span class="id-chip">sleep-token-even-in-arcadia</span>
      </p>

      <div class="field-group">
        <label for="toggle-id">Record ID</label>
        <input id="toggle-id" type="text" placeholder="randy, travis, storms..." />
        <div id="search-results" class="search-results"></div>
      </div>

      <div class="inline" style="margin-top: 0.5rem;">
        <button id="mark-sold-btn" type="button" class="btn btn-danger">
          Mark Sold (Hide from shop)
        </button>
        <button id="mark-available-btn" type="button" class="btn btn-secondary">
          Mark Available (Show on shop)
        </button>
      </div>
    </section>
  </div>

  <script>
    // === CONFIG: YOUR REPO ===
    const OWNER = "KornDog0804";
    const REPO  = "korndog-records-site";
    const BRANCH = "main";
    const PRODUCTS_PATH = "products.json";
    const IMAGES_FOLDER = "images";

    // === STATUS HELPERS ===
    const statusEl = document.getElementById("status");
    const statusText = document.getElementById("status-text");

    function setStatus(message, kind = "ok") {
      statusText.textContent = message;
      statusEl.classList.remove("ok", "error");
      if (kind === "ok") statusEl.classList.add("ok");
      if (kind === "error") statusEl.classList.add("error");
    }

    // === TOKEN HANDLING ===
    const TOKEN_KEY = "korndog_github_token";
    const tokenInput = document.getElementById("token-input");
    const saveTokenBtn = document.getElementById("save-token-btn");

    function getToken() {
      return localStorage.getItem(TOKEN_KEY) || "";
    }

    function requireToken() {
      const token = getToken();
      if (!token) {
        setStatus("No GitHub token set. Paste it above first.", "error");
        throw new Error("Missing GitHub token");
      }
      return token;
    }

    // On load, show short token hint if already set
    (function initTokenDisplay() {
      const existing = getToken();
      if (existing) {
        tokenInput.placeholder = "Token already set (•••" + existing.slice(-6) + ")";
        setStatus("GitHub token loaded. You’re ready to go.", "ok");
      }
    })();

    saveTokenBtn.addEventListener("click", () => {
      const value = tokenInput.value.trim();
      if (!value) {
        localStorage.removeItem(TOKEN_KEY);
        setStatus("GitHub token cleared. Paste a new one before saving records.", "error");
        return;
      }
      localStorage.setItem(TOKEN_KEY, value);
      tokenInput.value = "";
      tokenInput.placeholder = "Token set (•••" + value.slice(-6) + ")";
      setStatus("GitHub token saved. You’re wired into the repo.", "ok");
    });

    // === GITHUB HELPERS ===
    async function githubRequest(path, options = {}) {
      const token = requireToken();
      const headers = {
        "Authorization": "token " + token,
        "Accept": "application/vnd.github+json"
      };
      const res = await fetch(
        "https://api.github.com/repos/" + OWNER + "/" + REPO + "/contents/" + path,
        { ...options, headers: { ...headers, ...(options.headers || {}) } }
      );
      if (!res.ok) {
        const msg = await res.text();
        console.error("GitHub error:", msg);
        throw new Error("GitHub API error: " + res.status);
      }
      return res.json();
    }

    async function getFile(path) {
      const data = await githubRequest(path, { method: "GET" });
      const decoded = atob(data.content.replace(/\\n/g, ""));
      return { text: decoded, sha: data.sha };
    }

    async function putFile(path, contentText, message, sha) {
      const encoded = btoa(unescape(encodeURIComponent(contentText)));
      const body = {
        message,
        content: encoded,
        branch: BRANCH
      };
      if (sha) body.sha = sha;
      return githubRequest(path, {
        method: "PUT",
        body: JSON.stringify(body),
        headers: { "Content-Type": "application/json" }
      });
    }

    async function uploadImage(file) {
      const arrayBuffer = await file.arrayBuffer();
      const bytes = new Uint8Array(arrayBuffer);
      let binary = "";
      for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
      const base64 = btoa(binary);

      const safeName = Date.now() + "-" + file.name.replace(/[^a-zA-Z0-9_.-]/g, "_");
      const path = IMAGES_FOLDER + "/" + safeName;

      // NOTE: simple text-based upload; fine for web-sized JPG/PNG
      const binaryText = atob(base64);
      await putFile(path, binaryText, "Add image " + safeName);
      return path;
    }

    // === LOAD + SAVE PRODUCTS.JSON ===
    async function loadProductsJson() {
      const { text, sha } = await getFile(PRODUCTS_PATH);
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error("Bad products.json", e);
        throw new Error("products.json is not valid JSON");
      }
      if (!Array.isArray(data)) {
        throw new Error("products.json must be an array");
      }
      return { products: data, sha };
    }

    async function saveProductsJson(products, sha, message) {
      const text = JSON.stringify(products, null, 2);
      await putFile(PRODUCTS_PATH, text, message, sha);
    }

    // cache for quick searching
    let adminProductsCache = null;
    async function getAdminProducts() {
      if (adminProductsCache) return adminProductsCache;
      const { products } = await loadProductsJson();
      adminProductsCache = products;
      return adminProductsCache;
    }

    // === ADD FORM LOGIC ===
    const addForm = document.getElementById("add-form");
    const artistIdInput = document.getElementById("artist-id");
    const titleInput = document.getElementById("title");
    const priceInput = document.getElementById("price");
    const gradeInput = document.getElementById("grade");
    const descInput = document.getElementById("description");
    const qtyInput = document.getElementById("quantity");
    const coverInput = document.getElementById("cover");
    const availableInput = document.getElementById("available");

    addForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        requireToken();
      } catch {
        return;
      }

      const id = artistIdInput.value.trim();
      const title = titleInput.value.trim();
      const price = parseFloat(priceInput.value);
      const grade = gradeInput.value.trim();
      const description = descInput.value.trim();
      const quantity = parseInt(qtyInput.value || "1", 10) || 1;
      const available = availableInput.checked;
      const file = coverInput.files[0];

      if (!id || !title || !grade || !file || isNaN(price)) {
        setStatus("Missing required fields. Double-check the form.", "error");
        return;
      }

      setStatus("Uploading cover photo to GitHub…");

      try {
        const imagePath = await uploadImage(file);

        setStatus("Updating products.json…");

        const { products, sha } = await loadProductsJson();

        const existingIndex = products.findIndex((p) => p.id === id);
        const newProduct = {
          id,
          title,
          price,
          grade,
          image: imagePath,
          description,
          quantity,
          available
        };

        if (existingIndex >= 0) {
          products[existingIndex] = { ...products[existingIndex], ...newProduct };
        } else {
          products.push(newProduct);
        }

        await saveProductsJson(
          products,
          sha,
          (existingIndex >= 0 ? "Update record " : "Add record ") + id
        );

        adminProductsCache = products; // keep cache fresh

        setStatus("Saved! " + title + " is now in the JSON and ready to sell.", "ok");

        addForm.reset();
        qtyInput.value = "1";
        availableInput.checked = true;
      } catch (err) {
        console.error(err);
        setStatus("Something blew up talking to GitHub. Check console / token.", "error");
      }
    });

    // === SOLD / AVAILABLE TOGGLE + SEARCH ===
    const toggleIdInput = document.getElementById("toggle-id");
    const searchResults = document.getElementById("search-results");
    const markSoldBtn = document.getElementById("mark-sold-btn");
    const markAvailableBtn = document.getElementById("mark-available-btn");

    async function refreshSearchSuggestions() {
      const term = toggleIdInput.value.trim().toLowerCase();
      searchResults.innerHTML = "";
      if (!term) return;

      try {
        requireToken();
      } catch {
        return;
      }

      try {
        const products = await getAdminProducts();
        const matches = products.filter((p) => {
          const id = (p.id || "").toLowerCase();
          const title = (p.title || "").toLowerCase();
          return id.includes(term) || title.includes(term);
        }).slice(0, 8);

        matches.forEach((p) => {
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className = "search-pill";
          pill.textContent = p.id || p.title;
          pill.addEventListener("click", () => {
            toggleIdInput.value = p.id;
            searchResults.innerHTML = "";
          });
          searchResults.appendChild(pill);
        });
      } catch (err) {
        console.error(err);
      }
    }

    toggleIdInput.addEventListener("input", () => {
      refreshSearchSuggestions();
    });

    async function setAvailability(flag) {
      const rawInput = toggleIdInput.value.trim();
      if (!rawInput) {
        setStatus("Type part of the artist / title, then tap a pill or enter the id.", "error");
        return;
      }

      try {
        requireToken();
      } catch {
        return;
      }

      try {
        setStatus("Updating availability for " + rawInput + "…");

        const { products, sha } = await loadProductsJson();
        const search = rawInput.toLowerCase();

        let idx = products.findIndex(
          (p) => (p.id || "").toLowerCase() === search
        );

        if (idx === -1) {
          
