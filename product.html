<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Product • KornDog Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">

  <style>
    :root{
      --bg:#050013; --accent:#7bff5a; --text:#f5f5ff; --muted:#a1a1c5; --card:#12052b; --border:#2b1550;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #2a0a60 0, var(--bg) 55%);
    }
    a{color:inherit;text-decoration:none}
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(12px);
      background: linear-gradient(to right, rgba(10, 1, 30, 0.95), rgba(10, 1, 25, 0.9));
      border-bottom:1px solid rgba(123,255,90,.2);
    }
    .nav-inner{
      max-width:1100px; margin:0 auto; padding:.75rem 1.25rem;
      display:flex; align-items:center; justify-content:space-between; gap:1rem;
    }
    .logo-link{display:inline-flex;align-items:center;justify-content:center}
    .logo-circle{
      width:44px;height:44px;border-radius:999px;border:2px solid var(--accent);
      background: radial-gradient(circle at 30% 30%, #5a00ff, #140032);
      overflow:hidden;
    }
    .logo-circle img{width:100%;height:100%;object-fit:cover}
    nav{display:flex;align-items:center;gap:.75rem}
    .nav-link{
      padding:.6rem 1.6rem;border-radius:999px;font-size:.92rem;
      color:var(--muted);border:1px solid transparent;font-weight:600;
    }
    .nav-link:hover{border-color:rgba(123,255,90,.6);color:var(--text)}
    .cart-pill{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.45rem .9rem;border-radius:999px;
      background: rgba(123,255,90,.12);
      border:1px solid rgba(123,255,90,.5);
      font-size:.88rem;
    }
    .cart-pill span{
      background:var(--accent); color:#02010a;
      border-radius:999px; padding:.2rem .6rem; font-weight:800;
    }

    main{max-width:980px;margin:0 auto;padding:1.25rem 1.25rem 3rem;}
    .toprow{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0 16px;}
    .back{
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);font-weight:700;
    }
    .wrap{
      background: rgba(18,5,43,.85);
      border:1px solid rgba(255,255,255,.10);
      border-radius:24px;
      box-shadow: 0 24px 70px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .media{
      padding:16px;
      background: rgba(0,0,0,.18);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .media img{
      width:100%; height:auto; display:block;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
    }
    .thumbs{
      display:flex; gap:10px; padding:14px 16px 0;
      overflow:auto;
    }
    .thumbs button{
      width:72px;height:72px;border-radius:14px; flex:0 0 auto;
      border:1px solid rgba(123,255,90,.35);
      background: rgba(123,255,90,.08);
      overflow:hidden; cursor:pointer;
    }
    .thumbs img{width:100%;height:100%;object-fit:cover;display:block}
    .details{padding:16px;}
    h1{font-size:2.1rem;line-height:1.1;margin:4px 0 10px;font-weight:900;}
    .muted{color:var(--muted)}
    .price{margin-top:12px;font-size:1.3rem;font-weight:900;}
    .desc{margin-top:10px;color:var(--muted);line-height:1.45;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px;}
    .btn-primary{
      border-radius:999px;padding:.75rem 1.4rem;font-size:.95rem;
      border:none;cursor:pointer;font-weight:900;background:var(--accent);color:#02010a;
    }
    .btn-outline{
      border-radius:999px;padding:.75rem 1.4rem;font-size:.95rem;
      border:1px solid rgba(123,255,90,.55);
      background: transparent; color:var(--accent);
      cursor:pointer; font-weight:900;
    }
    .error{
      padding:18px; border:1px solid rgba(255,0,0,.25);
      background: rgba(255,0,0,.08); border-radius:16px;
      color:#ffd1d1;
    }
  </style>
</head>

<body>
  <header>
    <div class="nav-inner">
      <a href="index.html" class="logo-link" aria-label="Home">
        <div class="logo-circle">
          <img src="images/Screenshot_20250831-144625.png" alt="KornDog Records logo" />
        </div>
      </a>

      <nav>
        <a href="index.html" class="nav-link">Home</a>
        <a href="shop.html" class="nav-link">Shop</a>
        <a href="cart.html" class="nav-link cart-pill">Cart <span data-cart-count>0</span></a>
      </nav>
    </div>
  </header>

  <main>
    <div class="toprow">
      <a id="kdBackToShop" class="back" href="shop.html">← Back to Shop</a>
    </div>

    <div class="wrap" id="kdWrap">
      <div class="media">
        <img id="kdHero" alt="Record image" />
      </div>

      <div class="thumbs" id="kdThumbs" style="display:none;"></div>

      <div class="details">
        <h1 id="kdTitle">Loading…</h1>
        <div class="muted" id="kdGrade">Grade: —</div>
        <div class="price" id="kdPrice">$0.00</div>
        <div class="muted" id="kdQty">Qty available: —</div>
        <div class="desc" id="kdDesc"></div>

        <div class="actions">
          <button class="btn-primary" id="kdAdd">Add to Cart</button>
          <button class="btn-outline" id="kdCopy">Copy Share Link</button>
        </div>

        <div id="kdErr" style="display:none;margin-top:14px;" class="error"></div>
      </div>
    </div>
  </main>

  <script>
    // Prefer true back if they came from shop
    (function(){
      const btn = document.getElementById("kdBackToShop");
      if(!btn) return;
      btn.addEventListener("click", function(e){
        if (window.history.length > 1) { e.preventDefault(); window.history.back(); }
      });
    })();

    // Shared cart key (must match cart.html/script.js)
    const CART_KEY = "kd_cart_v1";

    function readCart(){
      try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
      catch(e){ return []; }
    }
    function writeCart(items){
      localStorage.setItem(CART_KEY, JSON.stringify(items));
      updateCartCount();
    }
    function updateCartCount(){
      const items = readCart();
      const count = items.reduce((sum, it) => sum + (Number(it.qty)||0), 0);
      document.querySelectorAll("[data-cart-count]").forEach(el => el.textContent = String(count));
    }

    function setError(msg){
      const box = document.getElementById("kdErr");
      box.style.display = "block";
      box.textContent = msg;
    }

    // Stable, dummy-proof ID maker (same rules you should use in Admin)
    function slugify(str) {
      return String(str || "")
        .toLowerCase()
        .trim()
        .replace(/[\u2018\u2019]/g, "'")      // curly apostrophes -> '
        .replace(/&/g, " and ")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "");
    }

    function getKeysFromUrl() {
      const params = new URLSearchParams(location.search);
      return {
        pid: params.get("pid") || "",
        id:  params.get("id")  || ""
      };
    }

    async function fetchProducts(){
      // IMPORTANT: products.json2 is your real source
      const tries = [
        "products.json2",
        "products.json",
        "product.json",
        "products.json2?v=1",
        "products.json?v=1",
        "product.json?v=1"
      ];

      for (const url of tries){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if(!res.ok) continue;
          const data = await res.json();
          if(Array.isArray(data)) return data;
          if(Array.isArray(data.products)) return data.products;
          if(Array.isArray(data.items)) return data.items;
        }catch(e){}
      }
      return null;
    }

    function findProduct(list, keys){
      if(!list) return null;

      const pid = String(keys.pid || "");
      const id  = String(keys.id  || "");

      // 1) exact pid match
      if (pid) {
        const hit = list.find(p => String(p.pid || "") === pid);
        if (hit) return hit;
      }

      // 2) exact id match
      if (id) {
        const hit = list.find(p => String(p.id || "") === id);
        if (hit) return hit;
      }

      // 3) pid in URL but record only has id (your common case)
      if (pid) {
        const hit = list.find(p => String(p.id || "") === pid);
        if (hit) return hit;
      }

      // 4) derived pid match (artist-title)
      if (pid) {
        const hit = list.find(p => {
          const derived =
            p.pid ||
            slugify(`${p.artist || ""}-${p.title || p.name || p.id || ""}`);
          return String(derived) === pid;
        });
        if (hit) return hit;
      }

      return null;
    }

    function normalizeProduct(p){
      // Your json2 supports images.front/images.back + imageFront/imageBack + image
      const front =
        p?.images?.front ||
        p.imageFront ||
        (typeof p.image === "string" ? p.image : "") ||
        (Array.isArray(p.images) ? p.images[0] : "");

      const back =
        p?.images?.back ||
        p.imageBack ||
        (Array.isArray(p.images) ? p.images[1] : "");

      const images = [];
      if (front) images.push(front);
      if (back && back !== front) images.push(back);

      const pid =
        p.pid ||
        slugify(`${p.artist || ""}-${p.title || p.name || p.id || ""}`) ||
        "";

      return {
        pid,
        id: p.id || "",
        name: (p.artist && (p.title || p.name))
          ? `${p.artist} — ${p.title || p.name}`
          : (p.name || p.title || "Record"),
        grade: p.grade || p.condition || "",
        price: Number(p.price)||0,
        desc: p.desc || p.description || "",
        qty: Number(p.qty || p.quantity || 1),
        images
      };
    }

    function addToCart(product){
      const items = readCart();

      const pid =
        product.pid ||
        product.id ||
        slugify(product.name) ||
        "";

      if(!pid) return;

      const found = items.find(x => x.pid === pid);
      if(found){
        found.qty = Math.min((Number(found.qty)||0) + 1, Number(product.qty)||99);
      }else{
        items.push({
          pid,
          name: product.name || "Record",
          price: Number(product.price)||0,
          image: product.images?.[0] || "",
          qty: 1,
          maxQty: Number(product.qty)||1
        });
      }
      writeCart(items);
    }

    (async function init(){
      updateCartCount();

      const keys = getKeysFromUrl();
      if(!keys.pid && !keys.id){
        setError("Missing product key. Use: product.html?pid=your-id OR product.html?id=your-id");
        return;
      }

      const list = await fetchProducts();
      if(!list){
        setError("Couldn’t load product data. Make sure products.json2 exists in the site root.");
        return;
      }

      const raw = findProduct(list, keys);
      if(!raw){
        setError("Product not found for: " + (keys.pid || keys.id));
        return;
      }

      const p = normalizeProduct(raw);

      const hero = document.getElementById("kdHero");
      const title = document.getElementById("kdTitle");
      const grade = document.getElementById("kdGrade");
      const price = document.getElementById("kdPrice");
      const qty = document.getElementById("kdQty");
      const desc = document.getElementById("kdDesc");
      const thumbs = document.getElementById("kdThumbs");

      title.textContent = p.name;
      grade.textContent = p.grade ? ("Grade: " + p.grade) : "Grade: —";
      price.textContent = "$" + p.price.toFixed(2);
      qty.textContent = "Qty available: " + (p.qty ?? 1);
      desc.textContent = p.desc || "";

      hero.src = p.images[0] || "";
      hero.onerror = () => { hero.removeAttribute("src"); hero.alt = "Image not available"; };

      if(p.images.length > 1){
        thumbs.style.display = "flex";
        thumbs.innerHTML = "";
        p.images.forEach((src, idx) => {
          const b = document.createElement("button");
          b.type = "button";
          b.setAttribute("aria-label", idx === 0 ? "View front" : "View back");
          b.innerHTML = `<img src="${src}" alt="">`;
          b.addEventListener("click", () => { hero.src = src; });
          thumbs.appendChild(b);
        });
      }

      document.getElementById("kdAdd").addEventListener("click", () => addToCart(p));

      document.getElementById("kdCopy").addEventListener("click", async () => {
        // Share pid if we have one, else share id
        const keyParam = p.pid
          ? ("pid=" + encodeURIComponent(p.pid))
          : ("id=" + encodeURIComponent(p.id || ""));

        const url = location.origin + location.pathname.replace(/\/[^/]*$/, "/") + "product.html?" + keyParam;

        try{
          await navigator.clipboard.writeText(url);
          const btn = document.getElementById("kdCopy");
          const old = btn.textContent;
          btn.textContent = "Copied ✅";
          setTimeout(()=>btn.textContent=old, 1200);
        }catch(e){
          alert(url);
        }
      });
    })();
  </script>
</body>
</html>
